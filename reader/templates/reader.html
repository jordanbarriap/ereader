{% load static %}
<html>
<head>
    <!--<link rel="stylesheet" type="text/css" href="{% static "annotorious-0.6.4/css/annotorious.css" %}" />-->
    <link rel="stylesheet" type="text/css" href="{% static "annotator/css/annotator.css" %}" />
    <!--<link rel="stylesheet" type="text/css" href="{% static "annotator/css/annotator.min.css" %}" />-->
    <link rel="stylesheet" type="text/css" href="{% static "knowledgevis/css/graph-editor.css" %}" />
    <link rel="stylesheet" type="text/css" href="{% static "reader/css/reader.css" %}" />
    <link rel="stylesheet" type="text/css" href="{% static "reader/css/modal.css" %}" />
    <link rel="stylesheet" type="text/css" href="{% static "reader/css/recommender.css" %}" />
    <link rel="stylesheet" type="text/css" href="{% static "annotator/view_annotator/css/style.css" %}" />
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.0/themes/base/jquery-ui.css">


    <link href="https://fonts.googleapis.com/css?family=Droid+Serif" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">


    <!--JQuery related imports-->
    <script src="{% static "reader/js/jquery-1.9.1.js" %}"></script>
    <script src="//code.jquery.com/ui/1.12.0-rc.1/jquery-ui.js"></script>

    <script type="text/javascript" src="{% static "reader/js/smart-learning-content.js" %}"></script>
    <script type="text/javascript" src="{% static "reader/js/wikipedia-content-recommender.js" %}"></script>
    <script type="text/javascript" src="{% static "annotator/js/annotator-full.min.js" %}"></script>
    <script type="text/javascript" src="{% static "annotator/js/short-unique-id.min.js" %}"></script>
    <script type="text/javascript" src="{% static "annotator/view_annotator/js/jquery.dateFormat.js" %}"></script>
    <script type="text/javascript" src="{% static "annotator/view_annotator/i18n/jquery.i18n.js" %}"></script>
    <script type="text/javascript" src="{% static "annotator/view_annotator/i18n/locale/en/annotator.js" %}"></script>
    <script type="text/javascript" src="{% static "annotator/view_annotator/js/view_annotator.js" %}"></script>
    <script type="text/javascript" src="{% static "annotator/view_annotator/js/jquery.slimscroll.js" %}"></script>
    <script type="text/javascript" src="{% static "annotator/tinymce/tinymce.min.js" %}"></script>
    <script type="text/javascript" src="{% static "annotator/view_annotator/js/richEditor.js" %}"></script>
    <!--<script type="text/javascript" src="{% static "annotorious-0.6.4/annotorious.min.js" %}"></script>-->


    <!-- Visualization related imports-->
    <script src="//d3js.org/d3.v3.min.js"></script>
    <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
    <script type="text/javascript" src="{% static "reader/js/cloud.js" %}"></script>


    <script type="text/javascript" src="{% static "reader/js/within-viewport/withinviewport.js" %}"></script>

    <!--<script src="https://hypothes.is/embed.js" async></script>-->

    <!-- Latest compiled and minified CSS -->
    <!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">-->
    <!-- Optional theme -->
    <!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">-->
    <!-- Latest compiled and minified JavaScript -->
    <!--<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>-->
    <!--<script type="text/javascript" src="{% static "reader/js/fisheye.js" %}"></script>-->
    <!--<script type="text/javascript" src="{% static "reader/js/rater/rater.js" %}"></script>-->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.11.2/moment.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/randomcolor/0.6.1/randomColor.min.js" integrity="sha512-vPeZ7JCboHcfpqSx5ZD+/jpEhS4JpXxfz9orSvAPPj0EKUVShU2tgy7XkU+oujBJKnWmu4hU7r9MMQNWPfXsYw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!--Tab sliders library and stylesheet-->
    <script src="https://cdn.rawgit.com/hawk-ip/jquery.tabSlideOut.js/v2.4/jquery.tabSlideOut.js"></script>
    <link rel="stylesheet" href="https://cdn.rawgit.com/hawk-ip/jquery.tabSlideOut.js/v2.4/jquery.tabSlideOut.css">

    <script src='https://kit.fontawesome.com/a076d05399.js' crossorigin='anonymous'></script>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
    <!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">-->

    <!-- Concept map editor required imports -->
    <script type="text/javascript" src="{% static "knowledgevis/js/graph-editor-functions.js" %}"></script>
    <script type="text/javascript" src="{% static "knowledgevis/js/graph-editor.js" %}"></script>



</head>
<body>
<div id="left-div">
    <div id="left-upper-div">
        <div id="toc-div">
        </div>
        <div id="vis-div">
        </div>
    </div>
    <div id="left-lower-div">
        <div id="concept-map-div">
        </div>
    </div>
</div>
<div id="reader-div">
   <div id="reader-controls">
        <a id="manual-link" href="{% static "reader/manuals/manual_ereader_v1.pdf" %}"target="_blank"><img id="icon-manual" src="{% static "reader/img/manual.png" %}" alt="user manual icon" />User Manual</a>
        <button class="previous-btn">❮ Previous</button>
        <span class="title-current-section"></span>
        <button class="quiz-btn" disabled>Go to quiz ✎</button>
        <button class="next-btn">Next ❯</button>

    </div>
    <div id="reader-canvas">
    </div>
</div>
<!--<div id="support-div">
    <div id="recommendations-div"></div>
    <div id="concepts-div"></div>
</div>-->

<!-- The Modal -->
<div id="myModal" class="modal">
  <!-- Modal content -->
    <div class="modal-content">
      <div class="modal-header">
        <span class="close">&times;</span>
        <h2 class="quiz-title">Quiz time!</h2>
      </div>
      <div class="modal-body">
          <p class="quiz-instructions"> Please ask the facilitator for the quiz corresponding to the section(s) that you just have finished reading.
              </br>
              </br>
              </br>Once you fill it completely, please return it to the facilitator and then, press the "Submit" button</p>
      </div>
      <div class="modal-footer">
        <button class="submit-btn">Submit</button>
      </div>
    </div>
</div>

<!-- Loader for making students wait -->
<div id="loader">
    <!--<img src="loading.gif" alt="Loading" /><br/>
    Loading…-->
</div>

<script type="text/javascript">

    //Global variables
    var user_id = "{{ request.user.id }}";
    var star1 = "{% static 'reader/img/0-star.png' %}";
    var star2 = "{% static 'reader/img/1-star.png' %}";
    var star3 = "{% static 'reader/img/2-star.png' %}";
    var star4 = "{% static 'reader/img/3-star.png' %}";

    if(user_id==null || user_id==undefined){
      user_id = "{{ request.usr }}";
    }

    var username = "{{username}}";

    var group_id = "{{ group }}";
    if(group_id==null || group_id==undefined){
      group_id = "{{ request.grp }}";
    }

    var svc = "{{ request.svc }}";
    var cid = "{{ cid }}";
    var url_sid = "{{ sid }}";

    var session = "{{ request.session.session_key }}";
    var current_section_id = "";

    var extra_base_url = ""; 
    if(location.hostname != "localhost" && location.hostname != '127.0.0.1'){
        extra_base_url = "/ereader";
    };
    var recommendation_approach = "jaccard_lemmatized";

    var social_comparison = true;
    var concept_map = false;
    var video_recommendation = false;

    var level_quiz_showing = 3;

    var last_page_read = {};
    var resource_id;
    var course_hierarchical_structure = {};
    var course_linear_structure = [];
    var quiz_data= {};
    var modal;

    var course_level_labels = ["Lectures","Chapters","Sections","Subsec.","Quizzes"];

    var tip_ind;

    var button_animation;

    var map_old_new_section_ids = {};
    var recommended_videos = [];
    var rec_resource_id = "";
    var recommended_activities = [];


    var assignments = [];
    var activity_urls = [];
    
    if(!concept_map){
      $("#concept-map-div").hide();
      $("#left-upper-div").height("98%");
    }
    var concept_map_width = $("#concept-map-div").innerWidth(),//window.innerWidth || docEl.clientWidth || bodyEl.clientWidth,
        concept_map_height =  $("#concept-map-div").innerHeight();//window.innerHeight|| docEl.clientHeight|| bodyEl.clientHeight;

    var xLoc = concept_map_width/2 - 25,
      yLoc = 100;


    var toc_color = d3.scale.linear()
        .domain([1,5])
        .range(["#F99B39","#FAD594"]);

    var color = d3.scale.linear()
        //.domain([0.0, 0.5, 1.0])
        .domain([0.0, 1.0])
        //.range(["red","yellow","green"]);
        //.range(["#E0E0E0", "#2562c3"]);
        .range(["#ffffff", "#2562c3"]);

    //This code loads the Youtube IFrame Player API code asynchronously.
    var tag = document.createElement('script');

    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    function onYouTubeIframeAPIReady(){
        console.log("Youtube API ready!");
    };

    // This function creates an <iframe> (and YouTube player)s
    // after the API code downloads.
    var player;
    var last_player_action = "";
    var last_time_player = -1;

    // The API will call this function when the video player is ready.
    function onPlayerReady(event) {
        //Log video load
        var player_action = "video-load";
        var video_id = player.getVideoData().video_id;
        $.post( "http://{{ request.META.HTTP_HOST }}"+extra_base_url+"/api/reader", JSON.stringify(
             {"user": "{{ request.user.id }}",
             "session": "{{ request.session.session_key }}",
             "group": "{{ group }}",
             "section": current_section_id,
             "section_name": last_page_read["name"],
             "resource": resource_id,
             "page": last_page_read["page"],
             "action":player_action,
             "datetime": new Date().toIsoString(),
             "visible_text": "",
             "extra": {"videoid":video_id,"resid":rec_resource_id}}));

        //Auto-play video when opened
        event.target.playVideo();
    }

    //  The API calls this function when the player's state changes.
    //  The function indicates that when playing a video (state=1),
    //  the player should play for six seconds and then stop.
    var done = false;
    var last_player_action = "";
    var last_player_time = -1;
    function onPlayerStateChange(event)
    {
        var video_id = player.getVideoData().video_id;
        var player_action = "";
        var current_player_time = Math.floor(player.getCurrentTime());
        console.log(event.data);
        if (event.data == YT.PlayerState.PLAYING){
            player_action = "play";
            if(last_player_action=="pause" && last_player_time==current_player_time){
                console.log("Play jump video");
                //console.log("play-jump: "+current_player_time);
            }else{
                 console.log("Play video clicked");
                 //console.log("play: "+current_player_time);
            }
        }
        else if(event.data == YT.PlayerState.PAUSED) {
            player_action = "pause";
        }
        else if(event.data == YT.PlayerState.ENDED) {
            player_action = "end";
        }else{
            return;
        }

        //Log video player actions
        $.post( "http://{{ request.META.HTTP_HOST }}"+extra_base_url+"/api/reader", JSON.stringify(
             {"user": {{ request.user.id }},
             "session": "{{ request.session.session_key }}",
             "group": "{{ group }}",
             "section": current_section_id,
             "section_name": last_page_read["name"],
             "resource": resource_id,
             "page": last_page_read["page"],
             "action":player_action,
             "datetime": new Date().toIsoString(),
             "visible_text": "",
             "extra": {"videoid":video_id,"time":current_player_time,"resid":rec_resource_id}}));

        last_player_time = current_player_time;
        last_player_action = player_action;

    }


    jQuery(function ($) {
        $.i18n.load(i18n_dict);

        $( document ).tooltip();

        var t = '';

        var csrftoken = getCookie('csrftoken');

        $.ajaxSetup({
            crossDomain: false, // obviates need for sameOrigin test
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type)) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });

        document.onkeydown = checkKey;

        //Load json that have the mapping between legacy ids and new ids
        $.getJSON("{% static "/reader/data/map_old_new_section_ids.json" %}",function(json){
            for(var i=0;i<json.length;i++){
                map_old_new_section_ids[json[i]["docno"]] = $.trim(json[i]["id"]);
            }
            //After loading the legacy ids, we can load the html file
            loadHtml();
        });


        /*$.ajax({
            url: 'http://halley.exp.sis.pitt.edu/behnam/book/api.php?sid=iir_14_2',
            headers: {
                'Content-Type' : 'application/x-www-form-urlencoded; charset=UTF-8'
            },
            method: 'GET',
            dataType: 'json',
            //data: dataSent,
            success: function(data){
                if(data.message == "OK"){
                    recommended_videos = data.items;
                }
            }
          });*/

        // Set the name of the hidden property and the change event for visibility
        var hidden, visibilityChange;
        if (typeof document.hidden !== "undefined") { // Opera 12.10 and Firefox 18 and later support
          hidden = "hidden";
          visibilityChange = "visibilitychange";
        } else if (typeof document.msHidden !== "undefined") {
          hidden = "msHidden";
          visibilityChange = "msvisibilitychange";
        } else if (typeof document.webkitHidden !== "undefined") {
          hidden = "webkitHidden";
          visibilityChange = "webkitvisibilitychange";
        }

        function handleVisibilityChange() {

            var section_id = last_page_read["id"];
            var section_name = last_page_read["name"];
            var resource_id = last_page_read["resourceid"];
            var page_num = last_page_read["page"];

            //Get all the text html containers
            var visible_text_elements = [];
            var visible_text = "";
            $("#page-container").find(".t").each(function(){
                if(isElementInViewport($(this))){
                    visible_text_elements.push($(this).attr("class"));
                    visible_text = visible_text + " " + $(this).text();
                }
            });
          if (document[hidden]) {
            //$.post( "http://{{ request.META.HTTP_HOST }}"+extra_base_url+"/ereader/api/reader", JSON.stringify(
            $.post( "http://{{ request.META.HTTP_HOST }}"+extra_base_url+"/api/reader", JSON.stringify(
             {"user": {{ request.user.id }},
             "session": "{{ request.session.session_key }}",
             "group": "{{ group }}",
             "section": section_id,
             "name": section_name,
             "resource": resource_id,
             "page": page_num,
             "action":"page-not-visible",
             //"datetime": new Date().toISOString(),
             "datetime": new Date().toIsoString(),
             "visible_text": visible_text_elements,
             "extra": []}));
          } else {
            //$.post( "http://{{ request.META.HTTP_HOST }}"+extra_base_url+"/ereader/api/reader", JSON.stringify(
            $.post( "http://{{ request.META.HTTP_HOST }}"+extra_base_url+"/api/reader", JSON.stringify(
             {"user": {{ request.user.id }},
             "session": "{{ request.session.session_key }}",
             "group": "{{ group }}",
             "section": section_id,
             "name": section_name,
             "resource": resource_id,
             "page": page_num,
             "action":"page-visible",
             //"datetime": new Date().toISOString(),
             "datetime": new Date().toIsoString(),
             "visible_text": visible_text_elements,
             "extra": []}));
          }
        }

        // Warn if the browser doesn't support addEventListener or the Page Visibility API
        if (typeof document.addEventListener === "undefined" || typeof document[hidden] === "undefined") {
          console.log("This demo requires a browser, such as Google Chrome or Firefox, that supports the Page Visibility API.");
        } else {
            // Handle page visibility change
            document.addEventListener(visibilityChange, handleVisibilityChange, false);
        }

        $('.previous-btn').click( function(e) {
            e.preventDefault();
            loadPreviousPage();
            return false;
        });

        $('.next-btn').click( function(e) {
            e.preventDefault();
            loadNextPage();
            return false;
        });

        $('.quiz-btn').click( function(e) {
            e.preventDefault();
            openQuizWindow();
            clearInterval(button_animation);
            return false;
        });

        $('.submit-btn').click( function(e) {
            e.preventDefault();
            var modal_header_text = e.target.parentNode.parentNode.childNodes[1].childNodes[3].innerHTML;
            console.log("inside submit",modal_header_text);
            submitQuiz();

            return false;
        });

        // Get the modal
        modal = document.getElementById('myModal');

        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];

        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
            closeModalWindow();
            //After the student close the activity modal, the user model is updated in order to provide progress feedback on the interface
            /*$.ajax({
            url: 'http://pawscomp2.sis.pitt.edu/aggregate2/GetContentLevels?usr=akhuseyinoglu&grp=SPLICELTI&sid=TEST&cid=368&mod=all&models=0&avgtop=10&updatesm=true',
            method: 'GET',
            dataType: 'text',
            //data: dataSent,
            success: function(data){
                var objKeysRegex = /({|,)(?:\s*)(?:')?([A-Za-z0-9_$\.][A-Za-z0-9_ \-\.$]*)(?:')?(?:\s*):/g;// look for object names
                var newQuotedKeysString = data.replace(objKeysRegex, "$1\"$2\":");// all object names should be double quoted
                //var jsondata = JSON.parse(newQuotedKeysString);
                var jsondata = eval('(' + data + ')');
                var jsondata_str = JSON.stringify(jsondata);
                //if(data.message == "OK"){
                console.log(jsondata);
                var progress_codeworkout = jsondata["learners"][0]["state"]["activities"]["Loops"]["CodeWorkout"]["repeatEnd"]["values"]["p"];//[0]["state"]["activities"]["Loops"]["CodeWorkout"]["endRepeat"];
                var attempts_codeworkout = jsondata["learners"][0]["state"]["activities"]["Loops"]["CodeWorkout"]["repeatEnd"]["values"]["a"];
                console.log(progress_codeworkout+"-a: "+attempts_codeworkout);

                //}
            },
            error : function(data,xhr,textStatus,errorThrown){
               console.log("getContentLevels did not work!");
               console.log(data);
               console.log("ERROR : ", errorThrown);
               console.log("ERROR : ", xhr);
               console.log("ERROR : ", textStatus);
            }
          });*/
        }

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
            if (event.target == modal) {
                closeModalWindow();
            }
        }

        function gText(e) {
            t = window.getSelection().toString();
            console.log(t);
            $.ajax({
                    url: 'http://en.wikipedia.org/w/api.php',
                    data: { action: 'query', list: 'search', srsearch: t, format: 'json' },
                    dataType: 'jsonp',
                    success: processResult
                });
        }

        function processResult(apiResult){
             for (var i = 0; i < apiResult.query.search.length; i++){
                  $('#recommendations-div').append('<p>'+apiResult.query.search[i].title+'</p>');
             }
        }

        //$("#left-lower-div").html('<iframe style="width:100%;height:100%;style="-webkit-transform:scale(0.5);-moz-transform-scale(0.5);" src="http://columbus.exp.sis.pitt.edu/interactive_concept_map/icm.jsp?userID=1&cmID=10&name=Network%20Basics:%20(Set%201)%20-%20Nodes%20and%20Links"></iframe>');
        //document.onmouseup = gText;


    });

// extension:
/*$.fn.scrollEnd = function(callback, timeout) {
  $(this).scroll(function(){
    var $this = $(this);
    if ($this.data('scrollTimeout')) {
      clearTimeout($this.data('scrollTimeout'));
    }
    $this.data('scrollTimeout', setTimeout(callback,timeout));
  });
};

$(window).bind('scrollStart', function(){
    scrolling = true;
    console.log('scrollStart');
});

$(window).bind('scrollEnd', function(){
    scrolling = false;
    console.log('scrollEnd');
});*/


function loadHtml() {
    {% autoescape off %}
    course_hierarchical_structure = {{course_hierarchical}};
    last_page_read = {{last_page_read}};
    url_section_id = "{{section_id}}";
    {% endautoescape %}

    hierarchicalToLinearStructure(course_hierarchical_structure);

    //If the user has not read any page from the course, the first page needs to be shown
    if(jQuery.isEmptyObject(last_page_read)){
      if(!jQuery.isEmptyObject(url_section_id)){
        var last_section_read = $.grep(course_linear_structure, function(d){ return d.id == url_section_id; });
        if(last_section_read.length > 0){
          last_page_read = last_section_read[0];
          if("spage" in last_page_read){
            last_page_read["page"] = last_page_read["spage"];
          }
        }else{
            last_section_read = findSection(course_hierarchical_structure.children,url_section_id);
            last_page_read = last_section_read["children"][0];
            console.log("First child of the section: ");
            console.log(last_page_read);
            last_page_read["page"] = last_page_read["spage"];
        }  
      }else{
        last_page_read = course_linear_structure[0];
        last_page_read["page"]=last_page_read["spage"];
      }
    }else{
        var last_section_read = $.grep(course_linear_structure, function(d){ return d.id == last_page_read["section"]; });
        var last_page_read_number = parseInt(last_page_read["page"]);
        last_page_read = last_section_read[0];
        last_page_read["page"] = last_page_read_number;
    }

    //Once the TOC is completely loaded, the view need to be focused on the current section
    $.when(initToc(course_hierarchical_structure)).then(function () {
        focusCurrentTocSection();
    });

    if (false) {(group_id!='CoTaPP22'&& group_id!='PFETest');}  // defunct condition check for specific groups to not load recommmendations or smart content
    //Load student 
    if(true){
     $.getJSON("http://{{ request.META.HTTP_HOST }}"+extra_base_url+"/api/reader/assignments?user="+user_id+"&group="+group_id,function(json){
         var result = json.result;
         if(result){
             assignments = json.assignments;
             var current_assignment = []
             current_assignment = assignments.filter(function(d){
                 var start_date = new Date(d.datetime_start);
                 var end_date = new Date(d.datetime_end);
                 var today_date = new Date();
                 return (today_date>=start_date && today_date<=end_date);
             })
             var str_current_assignment  = "";
             if(current_assignment.length>0){
                 str_current_assignment = "This week you have to perform the concept mapping activity associated with section(s) ";
                 for(var i=0;i<current_assignment.length;i++){
                     var section_id_assigned = current_assignment[i].section;
                     str_current_assignment = str_current_assignment+"'"+$("#toc-section-"+section_id_assigned).find("text").text()+"' ";
                 }
                 str_current_assignment = str_current_assignment+". You have to add at least 5 new concepts and 5 relationships between concepts to each concept map. Additionally, you have to evaluate the relevance of at least 10 recommended videos for each assigned section. Remember that you are encouraged to watch the recommended videos in order to discover new information about concepts or relationships that could be added to the concept map.";

                 for(var i=0;i<current_assignment.length;i++){
                     var section_assignment = current_assignment[i].section;
                     d3.select("#toc-section-"+section_assignment).append("svg:image")//('<img title="For this section the concept mapping activity is mandatory" class="concept-map-img" src="{% static "/reader/img/concept-map-icon.png" %}">');
                         .attr("width",25)
                         .attr("x",-22)
                         .attr("y",-12)
                         .attr("title","For this section, the concept mapping activity is mandatory")
                         .attr("xlink:href", "{% static "/reader/img/concept-map-icon.png" %}");
                 }

             }else{
                str_current_assignment = "This week you have to answer all the quizzes related to the current lecture";// (no concept-mapping / video rating activity).";
             }
             $("#reader-controls").append('<img id="assignment-img" height="30px" src="{% static "/reader/img/todo-icon.png" %}" title="'+str_current_assignment+'"></img>');
         }
         initProgressVis(course_hierarchical_structure);
         loadResource(last_page_read["id"],last_page_read["name"],last_page_read["resourceid"],last_page_read["page"],"site-load");

     })
   }else{
    loadResource(last_page_read["id"],last_page_read["name"],last_page_read["resourceid"],last_page_read["page"],"site-load");
   }
}


function initProgressVis(root){

    var margin = {top: 50, right: 2, bottom: 2, left: 2};

    var w = $("#vis-div").width() - margin.left - margin.right;
    var h = $("#vis-div").height()- margin.top - margin.bottom;
    //var h = $("#vis-div").height() - margin.bottom;

    var svg_size, quiz_bar_length;
    var x,y;
    if(social_comparison){
        quiz_bar_length = (w/2)*0.2;
        svg_size = w/2;//Change for making svg and svg-comp diferent
        x = d3.scale.linear()
            .range([0,w/2-quiz_bar_length]);
            //.range([0, h]);
    }else{
        quiz_bar_length = w*0.2;
        svg_size = w;
        x = d3.scale.linear()
            .range([0,w-quiz_bar_length]);
            //.range([0, h]);
    }

    y = d3.scale.linear()
            .range([0, h]);
            //range([0, w]);

    var quiz_bar_width = 1.5;

    var partition = d3.layout.partition()
        .sort(null)
        .children(function children(d) {
          return d.children;
        })
        .value(function(d) {return Math.log(d.epage-d.spage+2); });

    var x_comp = d3.scale.linear()
        .range([w/2-quiz_bar_length, 0]);

    var separation = 1;
    var y_separation = 1;

    updateProgressVis(course_hierarchical_structure);
    function updateProgressVis(root) {

    var x_quiz = d3.scale.linear()
            .range([0, quiz_bar_length]);
            //.range([0, h]);

    if(social_comparison){
        var svg_comp = d3.select("#vis-div").append("svg")
            .attr("id","svg-vis-comp")
            .attr("width", svg_size )
            .attr("height", h)
                .append("g")
                .attr("id","g_progress_vis_comp")
                .attr("transform", "translate(" + -1*margin.right + "," + margin.top + ")");//TODO: parametrize horizontal translation

        svg_comp.selectAll("text")
                .data(course_level_labels)
                .enter()
                .append("text")
                .attr("class","text-label")
                .text(function(d){return d;})
                //.attr("transform",function(d,i){return "translate("+(x_comp((i)/(course_level_labels.length+1))+10)+","+(y(1)+this.getComputedTextLength()+2)+") rotate(-90)";});
                .attr("transform",function(d,i){return "translate("+(x_comp((i)/(course_level_labels.length))+3*margin.right)+","+y(0)+") rotate(-60)";});

        svg_comp.append("text")
            .attr("class","vis-title")
            .text("Group")
            //.attr("transform",function(d){return "translate("+(w/2-this.getComputedTextLength())/2+",-"+(margin.top-15)+")";});
            .attr("transform",function(d){return "translate("+(w/4-this.getComputedTextLength()/2)+",-"+(margin.top-15)+")";});

        var rect_comp = svg_comp.selectAll("rect");

        rect_comp = rect_comp
              .data(partition(root))
            .enter().append("g")
                .attr("class", "vis-comp-section")
                /*.attr("class", function (d) {
                        classname = "partition_depth_" + d.depth;

                        //if (d.depth > 0){
                            classname += " partition_docno_" + d.docno;
                        //}

                        return classname;
                    })*/
                .attr("id",function(d){return "vis-comp-section-"+d.id})
                .on("click", visCompSectionClick)
                .on("mouseover", visSectionMouseover)
                .on("mouseout", visSectionMouseout)
                .append("rect")
              .attr("x", function(d) {
                    return x_comp(d.y) + x(d.dy); //- (d.depth-1)*separation;
                    //return d.depth*(separation+widthLayer);
                })
              .attr("y", function(d) { return y(d.x)+y_separation; })
              .attr("width", function(d) { return x(d.dy); })
              .attr("height", function(d) { return y(d.dx); })
              .attr("fill", function (d) {
                        var visited_pages = d.group_read_pages;
                        var total_section_pages = d.num_pages;
                        var proportion_visited_pages = visited_pages/total_section_pages;
                        return color(proportion_visited_pages);
                    })
              .attr("class", function (d) {
                        classname = "partition partition_depth_" + d.depth;

                        //if (d.depth > 0){
                            //classname += " partition_docno_" + d.docno;
                        //}

                        return classname;
                    })
              .attr("display", function(d) { return d.depth && d.depth<=4 ? null : "none"; })
              .attr("stroke-width",".5px")
              .attr("stroke","#4e5255")
              .attr("opacity",1)
              /*.on("click", visSectionClick)
              .on("dblclick", partitionTableDoubleClick)
              .on("mouseout",partitionTableMouseout);*/


        //var quiz_sections_comp = d3.selectAll("g.vis-comp-section").filter(function(d){return !d.children && d.quiz;});
        var quiz_sections_comp = d3.selectAll("g.vis-comp-section").filter(function(d){return d.depth==level_quiz_showing && (d.quiz || (d.children && d.children.map(function(e){return e.quiz;}).length>0));});

        quiz_sections_comp.append("rect")
            .attr("class","incorrects-bar")
            .attr("x", function (d) {
                var performance_quizzes = summarizePerformanceQuizzes(d,true);
                /*var corrects = d.quiz.corrects;
                var incorrects = d.quiz.incorrects;*/
                var corrects = performance_quizzes.corrects;
                var incorrects = performance_quizzes.incorrects;
                var attempts = corrects + incorrects;
                if(attempts==0){
                    return x_comp(1) + 2*x(d.dy) - x_quiz(0.5) - margin.right;
                }else{
                    return x_comp(1) + 2*x(d.dy) - x_quiz(incorrects/attempts) - margin.right;
                }

            })
            .attr("y", function (d) {
                return y(d.x) + y_separation - quiz_bar_width/2 + y(d.dx)/2;
            })
            .attr("width", function (d) {
                var performance_quizzes = summarizePerformanceQuizzes(d,true);
                /*var corrects = d.quiz.corrects;
                var incorrects = d.quiz.incorrects;*/
                var corrects = performance_quizzes.corrects;
                var incorrects = performance_quizzes.incorrects;
                var attempts = corrects + incorrects;
                if(performance_quizzes.has_questions){//modified by @jordan in 03-25-18
                    if(attempts==0){
                        return x_quiz(0.5);
                    }else{
                        return x_quiz(incorrects/attempts);
                    }
                }else{
                    return x_quiz(0);
                }


            })
            .attr("height", function (d) {
                return quiz_bar_width;
            })
            .attr("fill", function (d) {
                var performance_quizzes = summarizePerformanceQuizzes(d,true);
                /*var corrects = d.quiz.corrects;
                var incorrects = d.quiz.incorrects;*/
                var corrects = performance_quizzes.corrects;
                var incorrects = performance_quizzes.incorrects;
                if((corrects+incorrects)==0){
                    return "#ffffff";
                }else{
                    return "#ff2727";
                }
            });

        quiz_sections_comp.append("rect")
            .attr("class","corrects-bar")
            .attr("x", function (d) {
                var performance_quizzes = summarizePerformanceQuizzes(d,true);
                /*var corrects = d.quiz.corrects;
                var incorrects = d.quiz.incorrects;*/
                var corrects = performance_quizzes.corrects;
                var incorrects = performance_quizzes.incorrects;
                var attempts = corrects + incorrects;

                return x_comp(1) + 2*x(d.dy) - quiz_bar_length - margin.right;

            })
            .attr("y", function (d) {
                return y(d.x) + y_separation - quiz_bar_width/2 + y(d.dx)/2;
            })
            .attr("width", function (d) {
                var performance_quizzes = summarizePerformanceQuizzes(d,true);
                /*var corrects = d.quiz.corrects;
                var incorrects = d.quiz.incorrects;*/
                var corrects = performance_quizzes.corrects;
                var incorrects = performance_quizzes.incorrects;
                var attempts = corrects + incorrects;
                if(performance_quizzes.has_questions){//modified by @jordan 03-25-2018
                    if (attempts == 0) {
                        return x_quiz(0.5);
                    } else {
                        return x_quiz(corrects / attempts);
                    }
                }else{
                    return x_quiz(0);
                }

            })
            .attr("height", function (d) {
                return quiz_bar_width;
            })
            .attr("fill", function (d) {
                var performance_quizzes = summarizePerformanceQuizzes(d,true);
                /*var corrects = d.quiz.corrects;
                var incorrects = d.quiz.incorrects;*/
                var corrects = performance_quizzes.corrects;
                var incorrects = performance_quizzes.incorrects;
                if ((corrects+incorrects) == 0){
                    return "#ffffff";
                }else{
                    return "#ADFF2F";
                }
            });
    }

        tip_ind = d3.tip()
          .attr('class', 'd3-tip')
          .offset([-10, 0])
          .html(function(d) {
                var visited_pages = d.read_pages;
                var total_section_pages = d.num_pages;
                var group_visited_pages = d.group_read_pages;
                var proportion_visited_pages = visited_pages / total_section_pages;
                var proportion_group_visited_pages = group_visited_pages / total_section_pages;
                if(d.depth==level_quiz_showing && (d.quiz || (d.children && d.children.map(function(e){return e.quiz;}).length>0))){
                    var performance_quizzes = summarizePerformanceQuizzes(d,false);
                    var corrects = performance_quizzes.corrects;
                    var incorrects = performance_quizzes.incorrects;
                    var ind_success_rate=0;
                    if(corrects+incorrects>0){
                        ind_success_rate = corrects/(corrects+incorrects)
                    }
                    var performance_group_quizzes = summarizePerformanceQuizzes(d,true);
                    var corrects_group = performance_group_quizzes.corrects;
                    var incorrects_group = performance_group_quizzes.incorrects;
                    var group_success_rate = 0
                    if(corrects_group+incorrects_group>0){
                        group_success_rate = corrects_group/(corrects_group+incorrects_group)
                    }
                    if(performance_quizzes.has_questions && performance_group_quizzes.has_questions){//modified by @jordan 03-25-2018
                        return d.name+"<hr style='height:0.2em; visibility:hidden; margin:0px;'>Me ➜ Reading progress: "+(proportion_visited_pages*100).toFixed(0)+"% | Success rate: "+(ind_success_rate*100).toFixed(0)+"% <br><hr style='height:0.2em; visibility:hidden; margin:0px;'>Group ➜ Reading progress: "+(proportion_group_visited_pages*100).toFixed(0)+"% | Success rate: "+(group_success_rate*100).toFixed(0)+"%";
                    }else{
                        return d.name+"<hr style='height:0.2em; visibility:hidden; margin:0px;'>Me ➜ Reading progress: "+(proportion_visited_pages*100).toFixed(0)+"% <br><hr style='height:0.2em; visibility:hidden; margin:0px;'>Group ➜ Reading progress: "+(proportion_group_visited_pages*100).toFixed(0)+"%";
                    }
                }else{
                    return d.name+"<hr style='height:0.2em; visibility:hidden; margin:0px;'>Me ➜ Reading progress: "+(proportion_visited_pages*100).toFixed(0)+"% <br><hr style='height:0.2em; visibility:hidden; margin:0px;'>Group ➜ Reading progress: "+(proportion_group_visited_pages*100).toFixed(0)+"%";
                }
         });


        var svg_ind = d3.select("#vis-div").append("svg")
            .attr("id", "svg-vis")
            .attr("width", svg_size)
            .attr("height", h)
            .append("g")
            .attr("id", "g_progress_vis")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");//TODO: parametrize horizontal translation

        var text_labels = svg_ind.selectAll("text")
            .data(course_level_labels)
            .enter()
            .append("text")
            .text(function(d){return d;})
            //.style("font-size","8px")
            .attr("class","text-label")
            .attr("transform",function(d,i){
                return "translate("+(x((i)/(course_level_labels.length))+3*margin.left)+","+(y(0))+") rotate(-60)";
            });


        //Show "My progress" as a title of the visualization
        svg_ind.append("text")
        .attr("class","vis-title")
        .text("Me")
        .attr("transform",function(d){return "translate("+(w/4-this.getComputedTextLength()/2)+",-"+(margin.top-15)+")";});


        var rect = svg_ind.selectAll("rect");

        rect = rect
            .data(partition(root), function (d) {
                return d.id;
            })
            .enter().append("g")
            .attr("class", "vis-section")/*function (d) {
                classname = "partition_depth_" + d.depth;
                return classname;
            })*/
            .attr("id", function(d){return "vis-section-"+d.id;} )
            .on("click", visSectionClick)
            .on("mouseover", visSectionMouseover)
            .on("mouseout", visSectionMouseout)
            .append("rect")
            .attr("x", function (d) {
                return x(d.y) - x(d.dy); //+ (d.depth-1)*separation;
            })
            .attr("y", function (d) {
                return y(d.x) + y_separation;
            })
            .attr("width", function (d) {
                return x(d.dy);
            })
            .attr("height", function (d) {
                return y(d.dx);
            })
            .attr("fill", function (d) {
                var visited_pages = d.read_pages;
                var total_section_pages = d.num_pages;
                var proportion_visited_pages = visited_pages / total_section_pages;
                return color(proportion_visited_pages);
            })
            .attr("class", function (d) {
                classname = "partition partition_depth_" + d.depth;
                return classname;
            })
            .attr("id", function(d){return "vis-"+d.id;})
            .attr("display", function (d) {
                return d.depth && d.depth <= 4 ? null : "none";
            })
            .attr("stroke-width", ".5px")
            .attr("stroke", "#4e5255")
            .attr("opacity", 1);
        /*.on("dblclick", partitionTableDoubleClick)
          .on("mouseover",partitionTableMouseover)
          .on("mouseout",partitionTableMouseout);*/



        //var quiz_sections = d3.selectAll("g.vis-section").filter(function(d){return !d.children && d.quiz;});
        var quiz_sections = d3.selectAll("g.vis-section").filter(function(d){return d.depth==level_quiz_showing && (d.quiz || (d.children && d.children.map(function(e){return e.quiz;}).length>0));});

        quiz_sections.append("rect")
            .attr("class","incorrects-bar")
            .attr("x", function (d) {
                return x(1) - x(d.dy) + margin.left ;
            })
            .attr("y", function (d) {
                return y(d.x) + y_separation - quiz_bar_width/2 + y(d.dx)/2;
            })
            .attr("width", function (d) {
                var performance_quizzes = summarizePerformanceQuizzes(d,false);
                /*var corrects = d.quiz.corrects;
                var incorrects = d.quiz.incorrects;*/
                var corrects = performance_quizzes.corrects;
                var incorrects = performance_quizzes.incorrects;
                var attempts = corrects + incorrects;
                if(performance_quizzes.has_questions){//modified by @jordan 03-25-2018
                    if (attempts == 0) {
                        return x_quiz(0.5);
                    } else {
                        return x_quiz(incorrects / attempts);
                    }
                }else{
                    return x_quiz(0);
                }
            })
            .attr("height", function (d) {
                return quiz_bar_width;
            })
            .attr("fill", function (d) {
                var performance_quizzes = summarizePerformanceQuizzes(d,false);
                /*var corrects = d.quiz.corrects;
                var incorrects = d.quiz.incorrects;*/
                var corrects = performance_quizzes.corrects;
                var incorrects = performance_quizzes.incorrects;
                if((corrects+incorrects)==0){
                    return "#ffffff";
                }else{
                    return "#ff2727";
                }
            });
        quiz_sections.append("rect")
            .attr("class","corrects-bar")
            .attr("x", function (d) {
                var performance_quizzes = summarizePerformanceQuizzes(d,false);
                /*var corrects = d.quiz.corrects;
                var incorrects = d.quiz.incorrects;*/
                var corrects = performance_quizzes.corrects;
                var incorrects = performance_quizzes.incorrects;
                var attempts = corrects + incorrects;
                if(attempts==0){
                    return x(1) - x(d.dy) + x_quiz(0.5) + margin.left;
                }else{
                    return x(1) - x(d.dy) + x_quiz(incorrects/attempts) + margin.left;
                }

            })
            .attr("y", function (d) {
                return y(d.x) + y_separation - quiz_bar_width/2 + y(d.dx)/2;
            })
            .attr("width", function (d) {
                var performance_quizzes = summarizePerformanceQuizzes(d,false);
                /*var corrects = d.quiz.corrects;
                var incorrects = d.quiz.incorrects;*/
                var corrects = performance_quizzes.corrects;
                var incorrects = performance_quizzes.incorrects;
                var attempts = corrects + incorrects;
                if(performance_quizzes.has_questions){//modified by @jordan in 03-25-2018
                    if (attempts == 0) {
                        return x_quiz(0.5);
                    } else {
                        return x_quiz(corrects / attempts);
                    }
                }else{
                    return x_quiz(0);
                }
            })
            .attr("height", function (d) {
                return quiz_bar_width;
            })
            .attr("fill", function (d) {
                var performance_quizzes = summarizePerformanceQuizzes(d,false);
                /*var corrects = d.quiz.corrects;
                var incorrects = d.quiz.incorrects;*/
                var corrects = performance_quizzes.corrects;
                var incorrects = performance_quizzes.incorrects;
                if ((corrects+incorrects) == 0){
                    return "#ffffff";
                }else{
                    return "#ADFF2F";
                }
            });

        svg_ind.call(tip_ind);

        //Container for the gradients
        var defs = svg_ind.append("defs");

        //Code taken from http://stackoverflow.com/questions/9630008/how-can-i-create-a-glow-around-a-rectangle-with-svg
        //Filter for the outside glow
        var glow_filter = defs.append("filter")
            .attr("id","glow");

        glow_filter.append("feGaussianBlur")
            .attr("class", "blur")
            .attr("stdDeviation","4.5")
            .attr("result","coloredBlur");

        glow_feMerge = glow_filter.append("feMerge");
        glow_feMerge.append("feMergeNode")
            .attr("in","coloredBlur");
        glow_feMerge.append("feMergeNode")
            .attr("in","SourceGraphic");

        //Filter for colored shadows in the progress visualization
        var filter = defs.append("filter")
            .attr("id", "drop-shadow")

        filter.append("feGaussianBlur")
            .attr("in", "SourceAlpha")
            .attr("stdDeviation", 4)
            .attr("result", "blur");
        filter.append("feOffset")
            .attr("in", "blur")
            .attr("dx", 3)
            .attr("dy", 3)
            .attr("result", "offsetBlur")
        filter.append("feFlood")
            .attr("in", "offsetBlur")
            //.attr("flood-color", "#0052ff")
            .attr("flood-color", "#000000")
            .attr("flood-opacity", "0.5")
            .attr("result", "offsetColor");
        filter.append("feComposite")
            .attr("in", "offsetColor")
            .attr("in2", "offsetBlur")
            .attr("operator", "in")
            .attr("result", "offsetBlur");

        var feMerge = filter.append("feMerge");

        feMerge.append("feMergeNode")
            .attr("in", "offsetBlur")
        feMerge.append("feMergeNode")
            .attr("in", "SourceGraphic");

        /*svg.on("mousemove", function() {
            fisheye.focus(d3.mouse(this));
            rect.each(function(d) { d.fisheye = fisheye(d); })
                .attr("x",function(d){return d.fisheye.y;});
        });*/

        /*var subsections = svg.selectAll("g.partition_depth_2");

        subsections.append("circle")
            .attr("cx", function (d,i) {*/
        /*if (i%2){
                    return x(d.y)+x(d.dy)+40;
                }else{
                    return x(d.y)+40;
                }*/
        //return (x(d.y)+x(d.dy)/2+(separation*2)-1.5);
        /*return (x(d.y)+x(d.dy)/2+(separation*2)-1.5);
            })
            .attr("cy", function (d,i) { return y(d.x)+(y(d.dx)/2); })
            .attr("r", 2)
            .style("fill", "#c5c5c5")*/
        //.attr("stroke-width","0.5px")
        //.style("stroke", "black")
        /*.style("z-index","1000");*/

        /*subsections.append("text")
                .attr("dx", function(d){return x(d.y)+x(d.dy)/2+(separation*2)-3.5;})
                .attr("dy", function (d) { return y(d.x)+(y(d.dx)/2)+3;})
                .style("font-size","8px")
                .text("?");*/

        /*var subsections3 = svg.selectAll("g.partition_depth_3");


        subsections3.append("circle")
            .attr("cx", function (d,i) {*/
        /*if (i%2){
                    return x(d.y)+x(d.dy)+40;
                }else{
                    return x(d.y)+40;
                }*/
        //return x(d.y)+x(d.dy)/2+(separation*4)-1.5;
        /*return (Math.random()*30)+(1.7*x(d.y))+(separation*4)-1.5;
            })
            .attr("cy", function (d,i) { return y(d.x)+(y(d.dx)/2); })
            .attr("r", 2)
            .style("fill", "#c5c5c5")*/
        //.attr("stroke-width","0.5px")
        //.style("stroke", "black")
        /*.style("z-index","1000");*/
    }

}

function loadResource(section_id,section_name,resource_id,page_num,source){

    console.log(" section_id " + section_id+" section_name "+section_name+" resource_id "+resource_id+" page_num "+page_num);
     //Sets global variables which keeps the current_section_id
     current_section_id = section_id;

     var current_section = getSectionById(current_section_id);
     var epage = parseInt(current_section["epage"]);
     var spage = parseInt(current_section["spage"]);
     var kcs = current_section["kcs"];
     //console.log(kcs);
     var isConceptMapRequired = assignments.filter(function(d){return d.section === section_id}).length>0;

     //if (isConceptMapRequired){
     

     if(concept_map){
        $("#left-upper-div").css("height","28%");
        $("#left-lower-div").css("height","69%");
        loadConceptMap(user_id, section_id, section_name, "concept-map-div");
      }
     /*}else{
         $("#left-upper-div").css("height","100%");
         $("#left-lower-div").css("height","0%");
     }*/

     console.log("section_id:"+section_id+" epage: "+epage+" spage: "+spage+" page: "+page_num);

     //$("#toc-section-"+section_id).addClass("active");
    $(".previous-btn").prop("disabled",false);
    $(".next-btn").prop("disabled",false);
    $(".quiz-btn").prop("disabled",true);

    var last_section_read = $.grep(course_linear_structure, function(d){ return d.id == section_id; });
        last_section_read[0]["page"]=parseInt(page_num);
        last_page_read = last_section_read[0];


    $.when(unhighlightTocSections()).then(function () {
        highlightTocSection(section_id);
    });

    $.when(unhighlightVisSections()).then(function () {
        highlightVisSection(section_id);
    });

     if(page_num === spage){
        //$.get( "http://{{ request.META.HTTP_HOST }}"+extra_base_url+"/ereader/api/kcs",
        /*$.get( "http://{{ request.META.HTTP_HOST }}"+extra_base_url+"/api/kcs",
                 {"user": "{{ request.user.id }}",
                 "group": "{{ group }}",
                 "sections": last_page_read["id"]},
                function(data){
                    console.log(data);
                });*/
        console.log("First page loaded");
        var index_last_page_read = course_linear_structure.map(function(d) { return d.id; }).indexOf(last_page_read["id"]);
        console.log(index_last_page_read);
        if (index_last_page_read==0){
            $(".previous-btn").prop("disabled",true);
        }
     }/*else{
         clearInterval(button_animation);
     }*/
     //var section_quizzes_ids = Object.keys(section_quizzes);
     if(page_num === epage){
        //Load quiz, if there is any quiz related to the section
        loadQuiz();
         // if(section_quizzes_ids.indexOf(section_id)>-1 && !section_quizzes[section_id]){
            //$(".next-btn").prop("disabled",true);
            //$(".quiz-btn").prop("disabled",false);
         //}
        var index_last_page_read = course_linear_structure.map(function(d) { return d.id; }).indexOf(last_page_read["id"]);
        if (index_last_page_read==course_linear_structure.length-1){
            $(".next-btn").prop("disabled",true);
        }
     }else{
         clearInterval(button_animation);
     }

     hierarchicalCourseSectionUpdate(course_hierarchical_structure.children,section_id,parseInt(page_num));

     console.log("Current status of "+url_section_id);
     console.log(getSectionById(url_section_id));

     if((group_id=="CoTaPP22" || group_id=="PFETest") && (current_section_id.indexOf(url_section_id)>=0 || url_section_id==current_section_id)){
            console.log("I need to update the section");
            console.log(course_hierarchical_structure);
            //TODO
            //Add um2 query for sending progress part
            //http://adapt2.sis.pitt.edu/cbum/um
            app = 55;
            act=url_section_id;
            section_to_update  = getSectionById(url_section_id);
            if (section_to_update!== null && section_to_update.hasOwnProperty("num_pages") && section_to_update["num_pages"] != 0){
                progress = section_to_update["read_pages"]/section_to_update["num_pages"];
                sub = url_section_id;
                act = "ReadingMirror";
                var um_url = "http://adapt2.sis.pitt.edu/cbum/um" + "?app=" + app +
                                                    "&act=" + act + 
                                                    "&sub=" + sub +
                                                    "&res=" + progress +
                                                    "&usr=" + username +
                                                    "&grp=" + group_id +
                                                    //"&sid=" + "{{request.session.session_key}}" +
                                                    "&sid=" + url_sid +
                                                    "&svc=" + "ReadingMirror" +
                                                    "&cid=" + cid;
                $.post(um_url);
                console.log(um_url);
            }
            console.log("Section to update is empty");
     }

     if (group_id == "PFETest"){ // || group_id == "INFSCI2300Fall2022"){
        console.debug("inside PFETest");// or INFSCI2300Fall2022 ");
        fetchSmartContent("{{ request.META.HTTP_HOST }}"+extra_base_url, user_id, group_id,displaySmartContent);
     }

     if (group_id == "INFSCI2300Fall2022" || group_id == "INFSCI2140Fall2022"){
        console.debug("inside HIP wiki");
        var section_id = last_page_read["id"];
        var section_name = last_page_read["name"];
        var resource_file_id = last_page_read["resourceid"];
        var resource_page = last_page_read["page"];
        /*
        * last_page_read keys -- id(section_id), name (section_name),
        * spage (start page), epage(end page), resourceid (filename in html)
        *  num_pages, read_pages, read_pages_list, group_read_pages, quiz.
        *  parent, x, x0, y, y0
        * quiz - corrects, incorrects, corrects_group, incorrects_group, name
        * parent - id (group/course id), course name, num_pages (in book),
        * read_pages (num pages read), read_pages_list (pagenums read), value,
        * x, x0 , y, y0
        */
        var search_terms = section_name.split(' ');
        search_terms = search_terms.slice(2, search_terms.length).join(' ');
        var requestData = { 
            origin:'localhost',
            action: 'query',
            page: 'human information processing',   // not used
            list:'search',
            srsearch: search_terms, //'Cognitive Psychology: History and Overview', 
            srlimit: 500,
            format: 'json' 
        }
        fetchWikiContent("{{ request.META.HTTP_HOST }}"+extra_base_url, resource_id,page_num, user_id,group_id, displayWikiContent,requestData);
     }


     if (false){
        console.log("Inside IR wiki");
        var wikimap_pageid = map_old_new_section_ids[last_page_read["docno"]];
        fetchWikiContent("{{ request.META.HTTP_HOST }}"+extra_base_url, wikimap_pageid,"", user_id,group_id, displayWikiContent,requestData);
     }


     var resource_path = "resources/"+resource_id+"/"+resource_id+"-"+page_num+".html";

     $("#reader-canvas").load("{% static "/" %}"+resource_path,function() {

         //Set section title at the top of the reader
        $(".title-current-section").html(section_name+ "   ("+(last_section_read[0]["page"]-last_section_read[0]["spage"]+1)+"/"+(last_section_read[0]["epage"]-last_section_read[0]["spage"]+1)+")");

        if(assignments.map(function(d){return d.section;}).includes(section_id)){
            d3.select(".title-current-section").append("svg:image")//('<img title="For this section the concept mapping activity is mandatory" class="concept-map-img" src="{% static "/reader/img/concept-map-icon.png" %}">');
                 .attr("width",25)
                 .attr("x",-22)
                 .attr("y",-12)
                 .attr("title","For this section, the concept mapping activity is mandatory")
                 .attr("xlink:href", "{% static "/reader/img/concept-map-icon.png" %}");
        }
        //initWordCloud(text_html);

        var annotator = $('#page-container').annotator();

        var propietary = {{ request.user.id }};
        $('#page-container').annotator()
                 .annotator('addPlugin', 'Permissions', {
            user: propietary,
            permissions: {
                'read': [propietary],
                'update': [propietary],
                'delete': [propietary],
                'admin': [propietary]
         },
         showViewPermissionsCheckbox: true,
         showEditPermissionsCheckbox: false
        });



        $('#page-container').annotator().annotator('addPlugin', 'RichEditor');

        $('#page-container').annotator()
                 .annotator('addPlugin', 'Store', {
          // The endpoint of the store on your server.
          prefix: extra_base_url+"/annotator",

          // Attach the uri of the current page to all annotations to allow search.
          annotationData: {
            "uri": resource_id+"-"+page_num,
            "user": {{ request.user.id }},
            "session": "{{ request.session.session_key }}",
            "group": "{{ group }}",
            "username": "{{ request.user.username }}"
          },
          loadFromSearch: {
            "uri": resource_id+"-"+page_num,
            "group": "{{ group }}"
          },
          urls: {
            // These are the default URLs.
            create:  '/annotations',
            update:  '/annotations/:id',
            destroy: '/annotations/:id',
            search:  '/search'
          }
         });

        $('#page-container').annotator().annotator('addPlugin', 'AnnotatorViewer',{
            "user": {{request.user.id}}
        });
        
        // $('#anotacions-uoc-panel').slimscroll({height: '100%'});


         //Get all the text html containers
        var visible_text_elements = [];
        var visible_text = "";
        $("#page-container").find(".t").each(function(){
            if(isElementInViewport($(this))){
                visible_text_elements.push($(this).attr("class"));
                visible_text = visible_text + " " + $(this).text();
            }
        });

         var reader_height = document.getElementById("page-container").scrollHeight;

         var top = $("#page-container").scrollTop() - $("#page-container").offset().top;
         var bottom = top + window.innerHeight;

         top = Math.min(reader_height, Math.max(0, top));
         bottom = Math.min(reader_height, Math.max(0, bottom));

        // top and bottom are between 0 and 100
         top = (100 * top / reader_height).toFixed(4);
         bottom = (100 * bottom / reader_height).toFixed(4);

         var extra_info={"source":source,"top":top,"bottom":bottom};

         //$.post( "http://{{ request.META.HTTP_HOST }}"+extra_base_url+"/ereader/api/reader", JSON.stringify(
         $.post( "http://{{ request.META.HTTP_HOST }}"+extra_base_url+"/api/reader", JSON.stringify(
             {"user": {{ request.user.id }},
             "session": "{{ request.session.session_key }}",
             "group": "{{ group }}",
             "section": section_id,
             "name": section_name,
             "resource": resource_id,
             "page": page_num,
             "action":"page-load",
             //"datetime": new Date().toISOString(),
             "datetime": new Date().toIsoString(),
             "visible_text": visible_text_elements,
             "extra": extra_info}));

         //If user scrolls the page
        var t, l = (new Date()).getTime(), scrolling = false;

        $("#page-container").scroll(function(){
            var now = (new Date()).getTime();

            if(now - l > 400 && !scrolling ){
                $(this).trigger('scrollStart');
                l = now;
            }

            clearTimeout(t);
            t = setTimeout(function(){
                if (scrolling)
                    $("#page-container").trigger('scrollEnd');
            }, 300);
        });

         $("#page-container").bind('scrollStart', function(){
            scrolling = true;

            //Log scroll event by using the reader api

            //Get all the text html containers
            var visible_text_elements = [];
            var visible_text = "";
            $("#page-container").find(".t").each(function(){
                if(isElementInViewport($(this))){
                    visible_text_elements.push($(this).attr("class"));
                    visible_text = visible_text + " " + $(this).text();
                }
            });

		    var reader_height = document.getElementById("page-container").scrollHeight;

            var top = $("#page-container").scrollTop() - $("#page-container").offset().top;
		    var bottom = top + window.innerHeight;

		    top = Math.min(reader_height, Math.max(0, top));
		    bottom = Math.min(reader_height, Math.max(0, bottom));

		    // top and bottom are between 0 and 100
		    top = (100 * top / reader_height).toFixed(2);
		    bottom = (100 * bottom / reader_height).toFixed(2);

            var viewport_positions={"top":top,"bottom":bottom};
            //$.post( "http://{{ request.META.HTTP_HOST }}"+extra_base_url+"/ereader/api/reader", JSON.stringify(
            $.post( "http://{{ request.META.HTTP_HOST }}"+extra_base_url+"/api/reader", JSON.stringify(
             {"user": {{ request.user.id }},
             "session": "{{request.session.session_key}}",
             "group": "{{ group }}",
             "section": section_id,
             "name": section_name,
             "resource": resource_id,
             "page": page_num,
             "action":"page-scroll-start",
             "datetime": new Date().toISOString(),
             "visible_text": visible_text_elements,
             "extra":viewport_positions}) );
        });

        $("#page-container").bind('scrollEnd', function(){
            scrolling = false;
            console.log('scrollEnd');
            //Log scroll event by using the reader api

            //Get all the text html containers
            var visible_text_elements = [];
            var visible_text = "";
            $("#page-container").find(".t").each(function(){
                if(isElementInViewport($(this))){
                    visible_text_elements.push($(this).attr("class"));
                    visible_text = visible_text + " " + $(this).text();
                }
            });

		    var reader_height = document.getElementById("page-container").scrollHeight;
            console.log(reader_height);
            var top = $("#page-container").scrollTop() - $("#page-container").offset().top;
		    var bottom = top + window.innerHeight;

		    top = Math.min(reader_height, Math.max(0, top));
		    bottom = Math.min(reader_height, Math.max(0, bottom));

		    // top and bottom are between 0 and 100
		    top = (100 * top / reader_height).toFixed(4);
		    bottom = (100 * bottom / reader_height).toFixed(4);

		    console.log("top: "+top+"bottom: "+bottom);
            var viewport_positions={"top":top,"bottom":bottom};
            //$.post( "http://{{ request.META.HTTP_HOST }}"+extra_base_url+"/ereader/api/reader", JSON.stringify(
            $.post( "http://{{ request.META.HTTP_HOST }}"+extra_base_url+"/api/reader", JSON.stringify(
             {"user": {{ request.user.id }},
             "session": "{{request.session.session_key}}",
             "group": "{{ group }}",
             "section": section_id,
             "name": section_name,
             "resource": resource_id,
             "page": page_num,
             "action":"page-scroll-end",
             "datetime": new Date().toISOString(),
             "visible_text": visible_text_elements,
             "extra":viewport_positions}) );

        })

        if(false){ //group_id!="CoTaPP22" && group_id!="PFETest"){
            updateRecommendations();
        }
        /*$("#page-container").scrollEnd(function(){
            //Log scroll event by using the reader api

            //Get all the text html containers
            var visible_text_elements = [];
            var visible_text = "";
            $("#page-container").find(".t").each(function(){
                if(isElementInViewport($(this))){
                    visible_text_elements.push($(this).attr("class"));
                    visible_text = visible_text + " " + $(this).text();
                }
            });

		    var reader_height = document.getElementById("page-container").scrollHeight;
            console.log(reader_height);
            var top = $("#page-container").scrollTop() - $("#page-container").offset().top;
		    var bottom = top + window.innerHeight;

		    top = Math.min(reader_height, Math.max(0, top));
		    bottom = Math.min(reader_height, Math.max(0, bottom));

		    // top and bottom are between 0 and 100
		    top = (100 * top / reader_height).toFixed(4);
		    bottom = (100 * bottom / reader_height).toFixed(4);

		    console.log("top: "+top+"bottom: "+bottom);
            var viewport_positions={"top":top,"bottom":bottom};
            //$.post( "http://{{ request.META.HTTP_HOST }}"+extra_base_url+"/ereader/api/reader", JSON.stringify(
            $.post( "http://{{ request.META.HTTP_HOST }}"+extra_base_url+"/api/reader", JSON.stringify(
             {"user": {{ request.user.id }},
             "session": "{{request.session.session_key}}",
             "group": "{{ group }}",
             "section": section_id,
             "name": section_name,
             "resource": resource_id,
             "page": page_num,
             "action":"page-scroll",
             "datetime": new Date().toISOString(),
             "visible_text": visible_text_elements,
             "extra":viewport_positions}) );
        }, 100);*/
    });
}

function initWordCloud(text_string){
        var common = "poop,i,me,my,myself,we,us,our,ours,ourselves,you,your,yours,yourself,yourselves,he,him,his,himself,she,her,hers,herself,it,its,itself,they,them,their,theirs,themselves,what,which,who,whom,whose,this,that,these,those,am,is,are,was,were,be,been,being,have,has,had,having,do,does,did,doing,will,would,should,can,could,ought,i'm,you're,he's,she's,it's,we're,they're,i've,you've,we've,they've,i'd,you'd,he'd,she'd,we'd,they'd,i'll,you'll,he'll,she'll,we'll,they'll,isn't,aren't,wasn't,weren't,hasn't,haven't,hadn't,doesn't,don't,didn't,won't,wouldn't,shan't,shouldn't,can't,cannot,couldn't,mustn't,let's,that's,who's,what's,here's,there's,when's,where's,why's,how's,a,an,the,and,but,if,or,because,as,until,while,of,at,by,for,with,about,against,between,into,through,during,before,after,above,below,to,from,up,upon,down,in,out,on,off,over,under,again,further,then,once,here,there,when,where,why,how,all,any,both,each,few,more,most,other,some,such,no,nor,not,only,own,same,so,than,too,very,say,says,said,shall";

        var word_count = {};
        console.log("init wordcloud");
        var words = text_string.split(/[ '\-\(\)\*":;\[\]|{},.!?]+/);
          if (words.length == 1){
            word_count[words[0]] = 1;
          } else {
            words.forEach(function(word){
              var word = word.toLowerCase();
              if (word != "" && common.indexOf(word)==-1 && word.length>1){
                if (word_count[word]){
                  word_count[word]++;
                } else {
                  word_count[word] = 1;
                }
              }
            })
          }

        var svg_location = "#concepts-div";
        var width = document.getElementById("concepts-div").clientWidth;//$(document).width();
        var height = document.getElementById("concepts-div").clientHeight;//$(document).width();
        //var height = $(document).height();

        var fill = d3.scale.category20();

        var word_entries = d3.entries(word_count);

        var xScale = d3.scale.linear()
           .domain([0, d3.max(word_entries, function(d) {
              return d.value;
            })
           ])
           .range([10,100]);

        d3.layout.cloud().size([width, height])
          .timeInterval(20)
          .words(word_entries)
          .fontSize(function(d) { return xScale(+d.value); })
          .text(function(d) { return d.key; })
          .rotate(function() { return ~~(Math.random() * 2) * 90; })
          .font("Impact")
          .on("end", draw)
          .start();

        //d3.select("#concepts-div").remove();

        function draw(words) {

          d3.select("#concepts-div").append("svg")
              .attr("width", width)
              .attr("height", height)
            .append("g")
              .attr("transform", "translate(" + [width >> 1, height >> 1] + ")")
            .selectAll("text")
              .data(words)
            .enter().append("text")
              .style("font-size", function(d) { return xScale(d.value) + "px"; })
              .style("font-family", "Impact")
              .style("fill", function(d, i) { return fill(i); })
              .attr("text-anchor", "middle")
              .attr("transform", function(d) {
                return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
              })
              .text(function(d) { return d.key; });
        }

        d3.layout.cloud().stop();
      }

function isElementInViewport (el) {

    //special bonus for those using jQuery
    if (typeof jQuery === "function" && el instanceof jQuery) {
        el = el[0];
    }

    var rect = el.getBoundingClientRect();

    return (
        rect.top >= 0 &&
        rect.left >= 0 &&
        rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) && /*or $(window).height() */
        rect.right <= (window.innerWidth || document.documentElement.clientWidth) /*or $(window).width() */
    );
}

// Set up Django CSRF Token Protection
function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) == (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}

function visSectionClick(d){
    var section_metadata = d;
    var section_id = section_metadata["id"];
    var resource_id = section_metadata["resourceid"];
    var page_num = section_metadata["spage"];
    var section_name = section_metadata["name"];
    loadResource(section_id,section_name,resource_id,page_num,"click-vis-"+section_id);

    focusCurrentTocSection();
}

function visCompSectionClick(d){
    var section_metadata = d;
    var section_id = section_metadata["id"];
    var resource_id = section_metadata["resourceid"];
    var page_num = section_metadata["spage"];
    var section_name = section_metadata["name"];
    loadResource(section_id,section_name,resource_id,page_num,"click-vis-comp-"+section_id);

    focusCurrentTocSection();
}

function initToc(course_structure){
    var vis_element = d3.select('#g_progress_vis').node();
    //var margin_left = vis_element.getBoundingClientRect().width;
    var margin = {top: 10, right: 0, bottom: 5, left: 2};

    var i = 0;

    var tree = d3.layout.tree()
        .nodeSize([0, 10]);

    var diagonal = d3.svg.diagonal()
        .projection(function(d) { return [d.y, d.x]; });
    var width = $("#toc-div").width() - margin.left - margin.right;
    var svg = d3.select("#toc-div").append("svg")
        .attr("id","svg-toc")
        .attr("width", width)// + margin.left + margin.right)
        .append("g")
            .attr("id","g-toc")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    course_structure.x0 = 0;
    course_structure.y0 = 0;
    update(root = course_structure);

    function update(source) {

      // Compute the flattened node list. TODO use d3.layout.hierarchy.
      var nodes = tree.nodes(root);
      var margin = {top: 10, right: 0, bottom: 5, left: 5};

      var duration = 400;
      //var width = 400 - margin.left - margin.right,
      var  barHeight = 15,
        barWidth = width * .8;

      var height = Math.max(window.innerHeight, nodes.length * barHeight + margin.top + margin.bottom);


      d3.select("#svg-toc").transition()
          .duration(duration)
          .attr("height", height);

      d3.select(self.frameElement).transition()
          .duration(duration)
          .style("height", height + "px");

      // Compute the "layout".
      nodes.forEach(function(n, i) {
        n.x = i * barHeight;
      });

      // Update the nodes…
      var node = svg.selectAll("g.toc-section")
          .data(nodes, function(d) { return d.id || (d.id = ++i); });

      var nodeEnter = node.enter().append("g")
          .attr("class", "toc-section")
          .attr("id",function(d){return "toc-section-"+d.id;})
          .attr("transform", function(d) { return "translate(" + source.y0 + "," + source.x0 + ")"; })
          .style("opacity", 1e-6)
          .on("click", tocSectionClick);

      // Enter any new nodes at the parent's previous-btn position
      nodeEnter.filter(function(d) {
                return d.children && d.depth>0;
            })
        .append('path')
        .attr("class","toc-toggle active")
        .attr("d", d3.svg.symbol().type("triangle-down").size(60))
        .attr("transform", function(d) { return "translate(" + -6 + "," + 0+ ")"; })
        .style("fill", "#3d3d3d")
        .on("click", tocSectionToggle);

      nodeEnter.append("rect")
          .attr("y", -barHeight / 2)
          .attr("height", barHeight)
          .attr("width", function(d){ return d3.select("#svg-toc").attr("width");})
          .style("fill", "transparent");

      nodeEnter.append("text")
          .attr("dy", 5)
          .attr("dx", 5)
          .text(function(d) {
              if (d.depth == 2) {
                  return d.resourceid.toUpperCase() + "\n" + d.name;
              } else {
                  return d.name;
              }
          });


      // Transition nodes to their new position.
      nodeEnter.transition()
          .duration(duration)
          .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; })
          .style("opacity", 1);

      node.transition()
          .duration(duration)
          .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; })
          .style("opacity", 1)
        .select("rect");
          //.style("fill", "white");

      // Transition exiting nodes to the parent's new position.
      node.exit().transition()
          .duration(duration)
          .attr("transform", function(d) { return "translate(" + source.y + "," + source.x + ")"; })
          .style("opacity", 1e-6)
          .remove();

      /*
      // Update the links…
      var link = svg.selectAll("path.link")
          .data(tree.links(nodes), function(d) { return d.target.id; });

      // Enter any new links at the parent's previous-btn position.
      link.enter().insert("path", "g")
          .attr("class", "link")
          .attr("d", function(d) {
            var o = {x: source.x0, y: source.y0};
            return diagonal({source: o, target: o});
          })
        .transition()
          .duration(duration)
          .attr("d", diagonal);

      // Transition links to their new position.
      link.transition()
          .duration(duration)
          .attr("d", diagonal);

      // Transition exiting nodes to the parent's new position.
      link.exit().transition()
          .duration(duration)
          .attr("d", function(d) {
            var o = {x: source.x, y: source.y};
            return diagonal({source: o, target: o});
          })
          .remove();*/

      // Stash the old positions for transition.
      nodes.forEach(function(d) {
        d.x0 = d.x;
        d.y0 = d.y;
      });


    }

    // Toggle children on click.
    function tocSectionToggle(d) {

        d3.event.stopPropagation();

        if(d3.select(this).classed("active")){
            d3.select(this)
                .classed("active",false)
                .transition()
                .duration(300)
                .attr("transform","translate(-5,0) rotate(-90)");
        }else{
            d3.select(this)
                .classed("active",true)
                .transition()
                .duration(300)
                .attr("transform","translate(-5,0) rotate(0)");
        }
        if (d.children) {
            d._children = d.children;
            d.children = null;
            } else {
            d.children = d._children;
            d._children = null;
        }

        update(d);
        highlightTocSection(last_page_read["id"]);

    }

    function tocSectionClick(d){
        //d3.selectAll(".toc-section.active").attr("class","toc-section");
        //d3.select(this).attr("class","toc-section active");
        var section_metadata = d;
        var section_id = section_metadata["id"];
        var resource_id = section_metadata["resourceid"];
        var page_num = section_metadata["spage"];
        var section_name = section_metadata["name"];
        loadResource(section_id,section_name,resource_id,page_num,"click-toc-"+section_id);
    }

}

    function loadPreviousPage(){
        var epage = parseInt(last_page_read["epage"]);
        var spage = parseInt(last_page_read["spage"]);
        var page = parseInt(last_page_read["page"]);
        var resourceid = last_page_read["resourceid"];
        console.log("epage: "+epage+" spage: "+spage+" page: "+page+" resourceid: "+resourceid);
        if (page > spage){
            last_page_read["page"] = page - 1;
            loadResource(last_page_read["id"],last_page_read["name"],last_page_read["resourceid"],last_page_read["page"],"click-previous");
        }else{
            var index_last_page_read = course_linear_structure.map(function(d) { return d.id; }).indexOf(last_page_read["id"]);
            if(index_last_page_read >0 && index_last_page_read < course_linear_structure.length){
                last_page_read = course_linear_structure[index_last_page_read-1];
                console.log(last_page_read);
                if(last_page_read["epage"]==page && resourceid==last_page_read["resourceid"]){
                    if(parseInt(last_page_read["epage"])-parseInt(last_page_read["spage"])==0) {
                        last_page_read = course_linear_structure[index_last_page_read-2];
                        last_page_read["page"] = last_page_read["epage"];
                    }else{
                        last_page_read["page"] = parseInt(last_page_read["epage"])-1;
                    }
                }else{
                    last_page_read["page"] = last_page_read["epage"];
                }

                loadResource(last_page_read["id"],last_page_read["name"],last_page_read["resourceid"],last_page_read["page"],"click-previous");
            }
        }
    }

    function loadNextPage(){
        var epage = parseInt(last_page_read["epage"]);
        var spage = parseInt(last_page_read["spage"]);
        var page = parseInt(last_page_read["page"]);
        var resourceid = last_page_read["resourceid"];
        console.log("epage: "+epage+" spage: "+spage+" page: "+page+" resourceid: "+resourceid);

        if (page < epage){
            last_page_read["page"] = page + 1;
            console.log("next_page");
            if(last_page_read["page"]==epage){
                var index_last_page_read = course_linear_structure.map(function(d) { return d.id; }).indexOf(last_page_read["id"]);
                var selected_sections = getAncestors(d3.select("#toc-section-"+last_page_read["id"]).node().__data__);
                var selected_sections_ids =  selected_sections.map(function(d){return d.id;});

                //console.log(selected_sections);

                var section_quizzes_ids = [last_page_read["id"]];
                if(selected_sections.length>=level_quiz_showing){
                    section_quizzes_ids = [selected_sections[level_quiz_showing-1].id];
                    if(selected_sections[level_quiz_showing-1].children){
                        section_quizzes_ids = section_quizzes_ids.concat(selected_sections[level_quiz_showing-1].children.map(function(d){return d.id;})) ;
                    }

                }
                var current_subsections = section_quizzes_ids;
                //console.log(current_subsections);
                if(index_last_page_read<course_linear_structure.length-1) {
                    index_last_page_read = index_last_page_read + 1;
                    //console.log(course_linear_structure[index_last_page_read]);
                    while (index_last_page_read < course_linear_structure.length && course_linear_structure[index_last_page_read]["epage"] == epage && resourceid == course_linear_structure[index_last_page_read]["resourceid"] && current_subsections.indexOf(course_linear_structure[index_last_page_read]["id"])!=-1 ) {
                        //console.log(course_linear_structure[index_last_page_read]["id"]);
                        last_page_read["id"] = course_linear_structure[index_last_page_read]["id"];
                        last_page_read["name"] = last_page_read["name"] + " | " + course_linear_structure[index_last_page_read]["name"]
                        index_last_page_read++;
                    }
                }
            }

            loadResource(last_page_read["id"], last_page_read["name"], last_page_read["resourceid"], last_page_read["page"],"click-next");

        }else{
            var index_last_page_read = course_linear_structure.map(function(d) { return d.id; }).indexOf(last_page_read["id"]);
            if(index_last_page_read >=0 && index_last_page_read < course_linear_structure.length){
                last_page_read = course_linear_structure[index_last_page_read+1];
                if(last_page_read["spage"]==page && resourceid==last_page_read["resourceid"]){
                    if(parseInt(last_page_read["epage"])-parseInt(last_page_read["spage"])==0){
                        last_page_read = course_linear_structure[index_last_page_read+2];
                        last_page_read["page"] = last_page_read["spage"];
                    }else{
                        last_page_read["page"] = parseInt(last_page_read["spage"])+1;
                    }
                }else{
                    last_page_read["page"] = last_page_read["spage"];
                    if(last_page_read["page"]==last_page_read["epage"]){
                        console.log("next page is a end page");
                        epage = last_page_read["page"];
                        var index_last_page_read = course_linear_structure.map(function(d) { return d.id; }).indexOf(last_page_read["id"]);

                        var selected_sections = getAncestors(d3.select("#toc-section-"+last_page_read["id"]).node().__data__);
                        var selected_sections_ids =  selected_sections.map(function(d){return d.id;});

                        //console.log(selected_sections);

                        var section_quizzes_ids = [last_page_read["id"]];
                        if(selected_sections.length>=level_quiz_showing){
                            section_quizzes_ids = [selected_sections[level_quiz_showing-1].id];
                            if(selected_sections[level_quiz_showing-1].children){
                                section_quizzes_ids = section_quizzes_ids.concat(selected_sections[level_quiz_showing-1].children.map(function(d){return d.id;})) ;
                            }
                        }
                        var current_subsections = section_quizzes_ids;

                        console.log(current_subsections);

                        if(index_last_page_read<course_linear_structure.length-1) {
                            index_last_page_read = index_last_page_read + 1;
                            //console.log("we need to add one more subsection");
                            //console.log(course_linear_structure[index_last_page_read]);
                            while (index_last_page_read < course_linear_structure.length && course_linear_structure[index_last_page_read]["epage"] == epage && resourceid == course_linear_structure[index_last_page_read]["resourceid"] && current_subsections.indexOf(course_linear_structure[index_last_page_read]["id"])!=-1 ) {
                                //console.log(course_linear_structure[index_last_page_read]["id"]);
                                last_page_read["id"] = course_linear_structure[index_last_page_read]["id"];
                                last_page_read["name"] = last_page_read["name"] + " | " + course_linear_structure[index_last_page_read]["name"]
                                index_last_page_read++;
                            }
                        }
                    }
                }
                loadResource(last_page_read["id"],last_page_read["name"],last_page_read["resourceid"],last_page_read["page"],"click-next");
            }
        }
    }

    function visSectionMouseover(d, i) {
        //d3.select(this).style("opacity", 1.0);

        //d3.select(this).style("stroke","#000");
        //d3.select(this).style("stroke-width", "1");
        tip_ind.show(d);
        highlightVisSection(d.id);

        var section_id = last_page_read["id"];
        var section_name = last_page_read["name"];
        var resource_id = last_page_read["resourceid"];
        var page_num = last_page_read["page"];
        var date = new Date();
        var stringDateFull = moment(date).toISOString();
        var mouseovered_id = d3.select(this).attr("id");

        $.post( "http://{{ request.META.HTTP_HOST }}"+extra_base_url+"/api/reader", JSON.stringify(
             {"user": {{ request.user.id }},
             "session": "{{ request.session.session_key }}",
             "group": "{{ group }}",
             "section": section_id,
             "name": section_name,
             "resource": resource_id,
             "page": page_num,
             "action":"mouseover-"+mouseovered_id,
             "extra": {"progress": d3.select(".d3-tip").text()},
             //"datetime": new Date().toISOString(),
             "datetime": stringDateFull}));

        // Then highlight only those that are an ancestor of the current segment.
        //var sequenceArray = getAncestors(d);

        /*var highlighted_sections = d3.selectAll(".vis-section")
            .filter(function(node) {
                return (sequenceArray.indexOf(node) >= 0);
            })
            .select("rect")
            .transition()
            .duration(250)
                .style("opacity", 1)
                .style("stroke", "black")
                .style("stroke-width","1.5px")
                .attr("transform","translate(5,0)");
            //.style("filter", "url(#glow)");*/

        /*var not_highlighted_sections = d3.selectAll("rect")
            .filter(function(node) {
                return (sequenceArray.indexOf(node) < 0);
            })
            .style("opacity", 1)
            .style("stroke", "white")
            .style("stroke-width","0.5px");
            //.style("filter", "url(#glow)");

        highlighted_sections.moveToFront();*/

    }

    function resetModalHeaderFooter(){
        
        $('.quiz-title').html(`Quiz time!`);

        $('.modal-footer').empty();                         
        $('.modal-footer').append(`<button class="submit-btn">Submit</button>`); // reset to submit button
        $('.modal-header').height("8%");
        $('.modal-body').height("85%");
        $('.modal-footer').height("7%");

        
        $('.submit-btn').click( function(e) {
            e.preventDefault();
            var modal_header_text = e.target.parentNode.parentNode.childNodes[1].childNodes[3].innerHTML;
            console.log("inside submit",modal_header_text);
            submitQuiz();
            
            return false;
        });
    }
    
    function openQuizWindow(){
        modal.style.display = "block";
        $("#left-div").addClass("blurred");
        $("#page-container").addClass("blurred");
        
        resetModalHeaderFooter();   // reset wiki feedback or smart content feedback

        var section_id = last_page_read["id"];
        var section_name = last_page_read["name"];
        var resource_id = last_page_read["resourceid"];
        var page_num = last_page_read["page"];

        //$.post( "http://{{ request.META.HTTP_HOST }}"+extra_base_url+"/ereader/api/reader", JSON.stringify(
        $.post( "http://{{ request.META.HTTP_HOST }}"+extra_base_url+"/api/reader", JSON.stringify(
             {"user": {{ request.user.id }},
             "session": "{{ request.session.session_key }}",
             "group": "{{ group }}",
             "section": section_id,
             "name": section_name,
             "resource": resource_id,
             "page": page_num,
             "action":"quiz-load",
             //"datetime": new Date().toISOString(),
             "datetime": new Date().toIsoString(),
             "visible_text": []}));
    }

    function closeModalWindow(){
        modal.style.display = "none";
        modal.style.width = "100%";                     // wiki-modal
        
        if(false){
            if(group_id == "INFSCI2300Fall2022" || group_id == "INFSCI2140Fall2022"){   // store wiki feedback
                if (document.getElementById('wikipage')){
                    console.log("inside close_wiki");
                    submitWikiFeedback("{{ request.META.HTTP_HOST }}"+extra_base_url,user_id,group_id,"close_wiki");
                }
            }
        }

        $("#left-div").removeClass("blurred");
        $("#page-container").removeClass("blurred");

        var section_id = last_page_read["id"];
        var section_name = last_page_read["name"];
        var resource_id = last_page_read["resourceid"];
        var page_num = last_page_read["page"];

        $.post( "http://{{ request.META.HTTP_HOST }}"+extra_base_url+"/api/reader", JSON.stringify(
             {"user": {{ request.user.id }},
             "session": "{{ request.session.session_key }}",
             "group": "{{ group }}",
             "section": section_id,
             "name": section_name,
             "resource": resource_id,
             "page": page_num,
             "action":"modal-close",
             //"datetime": new Date().toISOString(),
             "datetime": new Date().toIsoString(),
             "visible_text": []}));

        //Cleans everything that was inside the modal
        $(".modal-body").empty();

        //Try to reload quiz into the modal in case it is the last page of a section
        var current_section = getSectionById(section_id)
        var epage = current_section["epage"]
        if(page_num == epage) {
            loadQuiz();
        }else{
            clearInterval(button_animation);
        }

        if(concept_map){
            loadConceptMap(user_id, current_section_id, section_name, "concept-map-div");
        }
    }

    function loadQuiz(){
        /*var section_quizzes = ["ir-4-1-1-1","ir-4-1-1-3","4-1-2-3","4-1-4"];
        if(section_quizzes.includes(last_page_read["id"])){
            alert("there is a quiz");
        }*/
        //$.get( "http://{{ request.META.HTTP_HOST }}"+extra_base_url+"/ereader/api/quiz",
        var selected_sections = getAncestors(d3.select("#toc-section-"+last_page_read["id"]).node().__data__);
        var selected_sections_ids =  selected_sections.map(function(d){return d.id;});
        //console.log(selected_sections);
        var section_quizzes_ids = [last_page_read["id"]];
        if(selected_sections.length>=level_quiz_showing){
            section_quizzes_ids = [selected_sections[level_quiz_showing-1].id];
            if(selected_sections[level_quiz_showing-1].children){
                section_quizzes_ids = section_quizzes_ids.concat(selected_sections[level_quiz_showing-1].children.map(function(d){return d.id;})) ;
            }
        }
        //console.log(section_quizzes_ids);
        if(section_quizzes_ids[section_quizzes_ids.length-1]!=last_page_read["id"]){
            clearInterval(button_animation);
            return;
        }
        $(".submit-btn").prop("disabled",false);
        $.get( "http://{{ request.META.HTTP_HOST }}"+extra_base_url+"/api/quiz",
             {"user": {{ request.user.id }},
             "group": "{{ group }}",
             //"section": last_page_read["id"]},
             "section": section_quizzes_ids.join()},
            function(data){
                quiz_data = data;
                $(".quiz-title").text(data["name"]);
                var questions = data["questions"];
                var question_ids = Object.keys(questions);
                console.log("question_ids",question_ids);
                var total_corrects = 0;
                if(question_ids.length>0){
                    //Insert questions in the quiz
                    $(".modal-body").empty();
                    var question_number = 0;
                    for(var i=0;i<question_ids.length;i++) {
                        var statement = questions[question_ids[i]]["statement"];
                        var type = questions[question_ids[i]]["type"];
                        question_number = question_number + 1;
                        if(type=="multiple-choice-one-answer") {
                            var question_id = question_ids[i];
                            var correct = questions[question_ids[i]]["correct"];
                            var disabled = "";
                            var previous_answer;
                            if (correct) {
                                total_corrects = total_corrects + 1;
                                disabled = "disabled";
                                previous_answer = questions[question_ids[i]]["previous_answer"];
                                $(".modal-body").append("<img class='correct-feedback-img' id='q" + question_id + "-feedback-img'>");
                                //$(".submit-btn").prop("disabled",true);
                            } else {
                                $(".modal-body").append("<img class='no-feedback-img' id='q" + question_id + "-feedback-img'>");
                            }

                            $(".modal-body").append("<p class='question-statement' id='q" + question_id + "-statement'>" + question_number + ".   " + statement + "</p>");
                            $(".modal-body").append("<ul id='q" + question_id + "'></ul>");
                            var choices = questions[question_id]["choices"];
                            for (var j = 0; j < choices.length; j++) {
                                var choice_id = choices[j]["id"]
                                var choice_statement = choices[j]["statement"];
                                if (previous_answer == choice_id) {
                                    $("#q" + question_ids[i]).append("<input class='multiple-choice-one-answer' type='radio' name='q" + question_id + "' value=" + choice_id + " " + disabled + " checked>" + choice_statement + "<br>");
                                } else {
                                    $("#q" + question_ids[i]).append("<input class='multiple-choice-one-answer' type='radio' name='q" + question_id + "' value=" + choice_id + " " + disabled + ">" + choice_statement + "<br>");
                                }
                            }
                            $(".modal-body").append("</br>");

                            //Track students' choice marks in the quiz but (before they submit they final answers)
                            console.log(question_id);
                            $("input[type=radio][name=q" + question_id + "]").change(function () {
                                var quiz_id = quiz_data["quiz"];
                                console.log($(this).attr("name").substring(1,$(this).attr("name").length));
                                //$.post( "http://{{ request.META.HTTP_HOST }}"+extra_base_url+"/ereader/api/quiz/attempt",
                                $.post("http://{{ request.META.HTTP_HOST }}"+extra_base_url+"/api/quiz/attempt",
                                    JSON.stringify({
                                        "quiz": quiz_id,
                                        "user": {{request.user.id}},
                                        "session": "{{ request.session.session_key }}",
                                        "group": "{{ group }}",
                                        "datetime": new Date().toIsoString(),
                                        "question": $(this).attr("name").substring(1,$(this).attr("name").length),
                                        "type": type,
                                        "answer": this.value
                                    }));
                            });
                        }

                        if(type=="textual"){
                            $(".modal-body").append("<p>"+question_number+".   "+statement+"</p>");
                            $(".modal-body").append("<textarea class='textual' id='q"+question_ids[i]+"' rows='3'></textarea>");
                        }

                        if(type=="multiple-choice-multiple-answer") {
                            var question_id = question_ids[i];
                            var correct = questions[question_ids[i]]["correct"];
                            var disabled = "";
                            var previous_answer=[];
                            if (correct) {
                                total_corrects = total_corrects + 1;
                                disabled = "disabled";
                                previous_answer = questions[question_ids[i]]["previous_answer"];
                                //In case the previous answer is not returned as an array we convert it in one
                                if(Number.isInteger(previous_answer)){
                                    previous_answer = [previous_answer];
                                }
                                $(".modal-body").append("<img class='correct-feedback-img' id='q" + question_id + "-feedback-img'>");
                                //$(".submit-btn").prop("disabled",true);
                            } else {
                                $(".modal-body").append("<img class='no-feedback-img' id='q" + question_id + "-feedback-img'>");
                            }

                            $(".modal-body").append("<p class='question-statement' id='q" + question_id + "-statement'>" + question_number + ".   " + statement + "</p>");
                            $(".modal-body").append("<ul id='q" + question_id + "'></ul>");
                            var choices = questions[question_id]["choices"];
                            for (var j = 0; j < choices.length; j++) {
                                var choice_id = choices[j]["id"]
                                var choice_statement = choices[j]["statement"];
                                if (previous_answer.indexOf(choice_id)!=-1) {
                                    $("#q" + question_ids[i]).append("<input class='multiple-choice-multiple-answer' type='checkbox' name='q" + question_id + "' value=" + choice_id + " " + disabled + " checked>" + choice_statement + "<br>");
                                } else {
                                    $("#q" + question_ids[i]).append("<input class='multiple-choice-multiple-answer' type='checkbox' name='q" + question_id + "' value=" + choice_id + " " + disabled + ">" + choice_statement + "<br>");
                                }
                            }
                            $(".modal-body").append("</br>");

                            //Track students' choice marks in the quiz but (before they submit they final answers)
                            $("input[type=checkbox][name=q" + question_id + "]").change(function () {
                                var quiz_id = quiz_data["quiz"];
                                var marked = $(this).is(":checked");
                                var action = "";
                                if (marked){
                                    action = "marked";
                                }else{
                                    action = "unmarked";
                                }
                                //$.post( "http://{{ request.META.HTTP_HOST }}"+extra_base_url+"/ereader/api/quiz/attempt",
                                $.post("http://{{ request.META.HTTP_HOST }}"+extra_base_url+"/api/quiz/attempt",
                                    JSON.stringify({
                                        "quiz": quiz_id,
                                        "user": {{request.user.id}},
                                        "session": "{{ request.session.session_key }}",
                                        "group": "{{ group }}",
                                        "datetime": new Date().toIsoString(),
                                        "question": $(this).attr("name").substring(1,$(this).attr("name").length),
                                        "type": type,
                                        "answer": this.value + " " + action
                                    }));
                            });
                        }
                    }

                    if(total_corrects == question_ids.length){
                         $(".submit-btn").prop('disabled', true);
                    }
                    //Enable quiz button
                    //$(".next-btn").prop('disabled', true);
                    $(".quiz-btn").prop('disabled', false);

                    button_animation = setInterval(function(){
                        $(".quiz-btn").effect('bounce', {times:4}, 800);
                    }, 1000);
                }else{
                    //No quiz to show
                    clearInterval(button_animation);
                    $(".next-btn").prop('disabled', false);
                    $(".quiz-btn").prop('disabled', true);

                }

            });
    }

    function showPreTest(data){
        var kcs = data["concepts"];
        var kcs_ids = Object.keys(kcs);
        for(var i=0;i<kcs_ids.length;i++){
            var kc_id = kcs_ids[i];
             $(".modal-body").append("<p>"+kcs[kc_id]+"</p><input type='range' min='1' max='7' value='3' class='slider' id='myRange'>");
        }
        $(".modal-body").empty();
    }

    function submitQuiz(){
        var quiz_completed = true;
        //section_quizzes[last_page_read["id"]]=true;
        $(".next-btn").prop("disabled",false);
        //$(".quiz-btn").prop("disabled",true);
        //closeQuizWindow();

        var section_id = last_page_read["id"];
        var section_name = last_page_read["name"];
        var resource_id = last_page_read["resourceid"];
        var page_num = last_page_read["page"];

        var answers = [];
        //Check if all multiple choice questions are added
        var questions = quiz_data["questions"];
        var questions_ids = Object.keys(questions);
        console.log(questions_ids);
        for(var i=0;i<questions_ids.length;i++){
            var question_id = questions_ids[i];
            question = questions[question_id];
            console.log(question_id);
            var type = question["type"];
            if(type=="multiple-choice-one-answer"){
                if (!$("input[name=q"+question_id+"]:checked").val()){
                    quiz_completed = false;
                }else{
                    //if($("input[name=q"+question_id+"]:checked").attr("enabled")){
                    if(!$("input[name=q"+question_id+"]:checked").prop("disabled")){
                        var selected_choices = $("input[name=q"+question_id+"]:checked").val();
                        console.log(selected_choices);
                        answers.push({"question_id":question_id, "type": type, "answer": selected_choices, "submitted":true});
                    }
                }
            }

            if(type=="multiple-choice-multiple-answer"){
                if (!$("input[name=q"+question_id+"]:checked").val()){
                    quiz_completed = false;
                }else{
                    //if($("input[name=q"+question_id+"]:checked").attr("enabled")){
                    if(!$("input[name=q"+question_id+"]:checked").prop("disabled")){
                        var selected_choices = [];
                        var selected_choices_array = $("#q"+question_id+" input:checked");
                        for(var j=0;j<selected_choices_array.length;j++){
                            selected_choices.push(selected_choices_array[j].value);
                        }
                        console.log(selected_choices);
                        answers.push({"question_id":question_id, "type": type, "answer": selected_choices, "submitted":true});
                    }
                }
            }

            if(type=="textual"){
                if ($('#q'+question_id).val() == ''){
                    quiz_completed = false;
                }else{
                    answers.push({"question_id":question_id, "type": type, "answer": $('#q'+question_id).val(), "submitted":true});
                }
            }

        }

        if(quiz_completed){
            //Deactivates the submit button for avoiding sending duplicate data | activates loader (@Jordan June 4th)
            $(".submit-btn").prop("disabled",true);
            loaderOn();

            var quiz_id= quiz_data["quiz"];
            //$.post( "http://{{ request.META.HTTP_HOST }}"+extra_base_url+"/ereader/api/reader", JSON.stringify(
            $.post( "http://{{ request.META.HTTP_HOST }}"+extra_base_url+"/api/reader", JSON.stringify(
             {"user": {{ request.user.id }},
             "session": "{{ request.session.session_key }}",
             "group": "{{ group }}",
             "section": section_id,
             "name": section_name,
             "resource": resource_id,
             "page": page_num,
             "action":"quiz-submit",
             //"datetime": new Date().toISOString(),
             "datetime": new Date().toIsoString(),
             "visible_text": []}) );

            /*$.ajax({
               url: "http://{{ request.META.HTTP_HOST }}"+extra_base_url+"/ereader/api/quiz/assess",*/
            $.ajax({
               url: "http://{{ request.META.HTTP_HOST }}"+extra_base_url+"/api/quiz/assess",
               data:
                   JSON.stringify({"quiz": quiz_id,
                   "user": {{request.user.id}},
                   "session": "{{ request.session.session_key }}",
                   "group": "{{ group }}",
                   "datetime": new Date().toIsoString(),
                   "answers": answers
                   }),
               error: function() {
                  alert('We could not process your quiz submission, please try it again');
               },
               success: function(data) {
                  loaderOff();
                  var assessment = data["assessment"];
                  var total_corrects = 0;
                  for (var i=0; i<assessment.length; i++){
                      var answer = assessment[i];
                      var type = answer["type"];
                      var question_id = answer["question_id"]
                      if(type=="multiple-choice-one-answer"){
                          var correct = answer["correct"];
                          $("#q"+question_id+"-feedback-img").removeClass();
                          if(correct==true){
                              total_corrects = total_corrects + 1;
                              $("#q"+question_id+"-feedback-img").addClass("correct-feedback-img");
                              $("input[name=q"+question_id+"]").prop("disabled",true);
                          }else{
                              $("#q"+question_id+"-feedback-img").addClass("incorrect-feedback-img");
                          }

                      }

                      if(type=="multiple-choice-multiple-answer"){
                          var correct = answer["correct"];
                          $("#q"+question_id+"-feedback-img").removeClass();
                          if(correct==true){
                              total_corrects = total_corrects + 1;
                              $("#q"+question_id+"-feedback-img").addClass("correct-feedback-img");
                              $("input[name=q"+question_id+"]").prop("disabled",true);
                          }else{
                              $("#q"+question_id+"-feedback-img").addClass("incorrect-feedback-img");
                          }

                      }
                  }
                  //If all the questions in the quiz are correct, we need to disable the submit button
                  if(total_corrects == assessment.length){
                      $(".submit-btn").prop("disabled",true);
                  }else{
                      $(".submit-btn").prop("disabled",false);
                  }
               },
               type: 'POST',
               contentType: 'application/json',
               dataType: 'json'
            });

            //$(".submit-btn").text("Go back to read ❯");

            /*$(".submit-btn").unbind("click");
            $(".submit-btn").click(function(e){
                e.preventDefault();
                modal.style.display = "none";
                //$(".quiz-btn").removeClass("quiz-btn").addClass("next-btn");
                //$(".next-btn").text("Next ❯");
                return false;
            });
            loadNextPage();*/
        }else{
            alert("Need to complete all your answers!");
        }
    }

    function visSectionMouseout(d, i) {
        tip_ind.hide(d);
        unhighlightVisSections();

        var section_id = last_page_read["id"];
        var section_name = last_page_read["name"];
        var resource_id = last_page_read["resourceid"];
        var page_num = last_page_read["page"];
        var date = new Date();
        var stringDateFull = moment(date).toISOString();
        var mouseovered_id = d3.select(this).attr("id");
        $.post( "http://{{ request.META.HTTP_HOST }}"+extra_base_url+"/api/reader", JSON.stringify(
             {"user": {{ request.user.id }},
             "session": "{{ request.session.session_key }}",
             "group": "{{ group }}",
             "section": section_id,
             "name": section_name,
             "resource": resource_id,
             "page": page_num,
             "action":"mouseout-"+mouseovered_id,
             "extra": {"progress": d3.select(".d3-tip").text()},
             "datetime": stringDateFull}));
    }

    function highlightVisSection(section_id){
      if(true){//(group_id!='CoTaPP22' && group_id!='PFETest'){
        var vis_path_to_highlight = getAncestors(d3.select("#vis-section-"+section_id).node().__data__);
        var sections_ids_to_highlight = vis_path_to_highlight.map(function(d){return d.id});
        for(var i=0;i<vis_path_to_highlight.length;i++){
            var section = vis_path_to_highlight[i]["id"];
            d3.select("g#vis-section-"+section)
                .attr("class","vis-section active")
                .select("rect")
                    .transition()
                    .duration(100)
                    //.attr("transform","translate(5,0)")
                    .style("opacity",1)
                    //.style("stroke","#0052ff")
                    .style("stroke","#fe9103")
                    //.style("stroke","#272727")
                    .style("stroke-width","2px")
                    .style("filter", "url(#drop-shadow)");
             d3.select("g#vis-section-"+section).moveToFront();

            if(social_comparison) {
                 d3.select("g#vis-comp-section-"+section)
                    .attr("class","vis-comp-section active")
                    .select("rect")
                        .transition()
                        .duration(100)
                        //.attr("transform","translate(5,0)")
                        .style("opacity",1)
                        //.style("stroke","#0052ff")
                        .style("stroke","#fe9103")
                        //.style("stroke","#272727")
                        .style("stroke-width","2px")
                        .style("filter", "url(#drop-shadow)");
                 d3.select("g#vis-comp-section-"+section).moveToFront();
            }
        }
      }
    }

    function unhighlightVisSections(){
      if(true){ //(group_id!='CoTaPP22' && group_id!='PFETest'){
        var selected_sections = getAncestors(d3.select("#vis-section-"+last_page_read["id"]).node().__data__);
        var selected_sections_ids =  selected_sections.map(function(d){return d.id;});
        var selector = "g.vis-section.active";
        for(var i=0;i<selected_sections_ids.length;i++){
            selector = selector + ":not(#vis-section-"+selected_sections_ids[i]+")";
        }
        var unhighlighted_sections = d3.selectAll(selector)
            /*.filter(function(d){
                return selected_sections_ids.indexOf(d.id)==-1;
            })*/
            .attr("class","vis-section")
            .select("rect")
                .transition()
                .duration(100)
                .attr("transform","translate(0,0)")
                .style("stroke","#4e5255")
                .style("stroke-width",".5px")
                .style("filter", "none");

        d3.selectAll("g.vis-section")
            .filter(function(d){
                return selected_sections_ids.indexOf(d.id)!=-1;
            }).moveToFront();

        if(social_comparison){
            var selected_comp_sections = getAncestors(d3.select("#vis-comp-section-"+last_page_read["id"]).node().__data__);
            var selected_comp_sections_ids =  selected_comp_sections.map(function(d){return d.id;});
            var comp_selector = "g.vis-comp-section.active";
            for(var i=0;i<selected_comp_sections_ids.length;i++){
                comp_selector = comp_selector + ":not(#vis-comp-section-"+selected_comp_sections_ids[i]+")";
            }

            var unhighlighted_comp_sections = d3.selectAll(comp_selector)
                /*.filter(function(d){
                    return selected_sections_ids.indexOf(d.id)==-1;
                })*/
                .attr("class","vis-comp-section")
                .select("rect")
                    .transition()
                    .duration(100)
                    .attr("transform","translate(0,0)")
                    .style("stroke","#4e5255")
                    .style("stroke-width",".5px")
                    .style("filter", "none");

            d3.selectAll("g.vis-comp-section")
                .filter(function(d){
                    return selected_comp_sections_ids.indexOf(d.id)!=-1;
                }).moveToFront();
        }
      }



    }

    function unhighlightTocSections(){
        var selected_sections = getAncestors(d3.select("#toc-section-"+last_page_read["id"]).node().__data__);
        var selected_sections_ids =  selected_sections.map(function(d){return d.id;});
        var selector = "g.toc-section.active";
        for(var i=0;i<selected_sections_ids.length;i++){
            selector = selector + ":not(#toc-section-"+selected_sections_ids[i]+")";
        }

        var unhighlighted_sections = d3.selectAll(selector)
            /*.filter(function(d){
                return selected_sections_ids.indexOf(d.id)==-1;
            })*/
            .attr("class","toc-section")
            .select("rect")
                .style("stroke","white")
                .style("fill","white");

        /*d3.selectAll("g.toc-section")
            .filter(function(d){
                return selected_sections_ids.indexOf(d.id)!=-1;
            }).moveToFront();*/


    }


    function highlightTocSection(section_id){
        var toc_path_to_highlight = getAncestors(d3.select("#toc-section-"+section_id).node().__data__);
        for(var i=0;i<toc_path_to_highlight.length;i++){
            var section = toc_path_to_highlight[i]["id"];
            if(i==toc_path_to_highlight.length-1){
                d3.select("g#toc-section-"+section)
                .attr("class","toc-section active")
                    .select("rect")
                    .style("stroke","#fe9103")
                    .style("stroke-width","1.5px")
                    .style("fill","#ff8d03")
                    .style("opacity",0.7);
                    //.style("filter","url(#glow");
            }
        }
    }

    function getAncestors(node) {
      var path = [];
      var current = node;
      while (current.parent) {
        path.unshift(current);
        current = current.parent;
      }
      return path;
    }

    function getSectionById(section_id){
        //TODO: check if section exists first or not
        var sectionArray = $.grep(course_linear_structure, function(d){ return d.id == section_id;});
        if(sectionArray.length>0){
          section = sectionArray[0];
        }else{
          section = findSection(course_hierarchical_structure.children,section_id);
        }
        return section;
    }

    function hierarchicalCourseSectionUpdate(sections, section_id, page) {
        for (section_index in sections){
            var section = sections[section_index];
            if (section["id"] == section_id) {
                updateReadPage(section, page);
                return true;
            }
            // Item not returned yet. Search its children by recursive call.
            if (section.children) {
                var subresult = hierarchicalCourseSectionUpdate(section.children, section_id, page);
                // If the item was found in the subchildren, return it.
                if (subresult){
                    updateReadPage(section, page);
                    return true;
                }

            }
        }
        return false;
    }

    function updateReadPage(section, page){
        if(section["read_pages_list"].indexOf(page)==-1){
            section["read_pages_list"].push(page);
            section["read_pages"]=section["read_pages"]+1;
            d3.select("#vis-"+section["id"]).transition()
                .duration(300)
                .attr("fill", function(d){
                    console.log("Updating color");
                    var visited_pages = section["read_pages"];
                    var total_section_pages = d.num_pages;
                    var proportion_visited_pages = visited_pages / total_section_pages;
                    return color(proportion_visited_pages)});
            if(section["parent"]){
                updateReadPage(section["parent"],page);
            }
            
        }
    }

    function hierarchicalToLinearStructure(data){

        if (data.children){
            var current_subsection = Object.assign({}, data);
            delete current_subsection['children'];
            if(current_subsection.epage !==undefined && current_subsection.spage!==undefined && current_subsection.resourceid!==undefined) {
                course_linear_structure.push(current_subsection);
            }
            data.children.forEach(function(d,i){
                    hierarchicalToLinearStructure(d);
                });
        }else{
            course_linear_structure.push(data);
        }

    }

    // https://github.com/wbkd/d3-extended
    d3.selection.prototype.moveToFront = function() {
      return this.each(function(){
        this.parentNode.appendChild(this);
      });
    };


    d3.selection.prototype.moveToBack = function() {
        return this.each(function() {
            var firstChild = this.parentNode.firstChild;
            if (firstChild) {
                this.parentNode.insertBefore(this, firstChild);
            }
        });
    };

    Date.prototype.toIsoString = function() {
        var tzo = -this.getTimezoneOffset(),
            dif = tzo >= 0 ? '+' : '-',
            pad = function(num) {
                var norm = Math.floor(Math.abs(num));
                return (norm < 10 ? '0' : '') + norm;
            };
        return this.getFullYear() +
            '-' + pad(this.getMonth() + 1) +
            '-' + pad(this.getDate()) +
            'T' + pad(this.getHours()) +
            ':' + pad(this.getMinutes()) +
            ':' + pad(this.getSeconds()) +
            dif + pad(tzo / 60) +
            ':' + pad(tzo % 60);
    }

function focusCurrentTocSection(){
    var current_position = $("#toc-div").scrollTop();
    var section_position =  $("g#toc-section-"+last_page_read["id"]).offset().top

    $('#toc-div').animate({
        scrollTop: current_position+section_position-$("#toc-div").height()/2
    }, 200);
}

function checkKey(e) {

    e = e || window.event;

    /*if (e.keyCode == '38') {
        // up arrow
    }
    else if (e.keyCode == '40') {
        // down arrow
    }*/
    if (e.keyCode == '37') {
       // left arrow
        loadPreviousPage();

    }
    else if (e.keyCode == '39') {
       // right arrow
        loadNextPage();
    }

}

function summarizePerformanceQuizzes(section,group){//modified by @jordan at 03-25-2018
    var corrects = 0;
    var incorrects = 0;
    var has_questions = false;

    if(!group){
        if(section.quiz!=undefined){//in case the parent section has a related quiz
            corrects = section.quiz.corrects;
            incorrects = section.quiz.incorrects;
            has_questions = true;
        }
        if(section.children){//add the children section quizzes
            var quizzes_children_sections = section.children.map(function(d){return d.quiz;});
            quizzes_children_sections.clean(undefined);

            for(var i=0;i<quizzes_children_sections.length;i++){
                corrects = corrects + quizzes_children_sections[i].corrects;
                incorrects = incorrects + quizzes_children_sections[i].incorrects;
                has_questions = true;
            }
        }
    }else{

        if(section.quiz!=undefined){//in case the parent section has a related quiz
            corrects = section.quiz.corrects_group;
            incorrects = section.quiz.incorrects_group;
            has_questions = true;
        }
        if(section.children){//add the children section quizzes
            var quizzes_children_sections = section.children.map(function(d){return d.quiz;});
            quizzes_children_sections.clean(undefined);

            for(var i=0;i<quizzes_children_sections.length;i++){
                corrects = corrects + quizzes_children_sections[i].corrects_group;
                incorrects = incorrects + quizzes_children_sections[i].incorrects_group;
                has_questions = true;
            }
        }
    }

    return {"corrects":corrects, "incorrects":incorrects, "has_questions": has_questions};
}

Array.prototype.clean = function(deleteValue) {
  for (var i = 0; i < this.length; i++) {
    if (this[i] == deleteValue) {
      this.splice(i, 1);
      i--;
    }
  }
  return this;
};

function isNumber(n) { return !isNaN(parseFloat(n)) && !isNaN(n - 0) }

function loaderOn() {
    document.getElementById("loader").style.display = "block";
}

function loaderOff() {
    document.getElementById("loader").style.display = "none";
}

function wait(ms){
   var start = new Date().getTime();
   var end = start;
   while(end < start + ms) {
     end = new Date().getTime();
  }
}

function openVideoWindow(video_id,res_id,rating,explanation_rating,ranking,score,is_noise){

    var section_name = last_page_read["name"];
    rec_resource_id = res_id;
    var resource_id = last_page_read["resourceid"];
    var page_num = last_page_read["page"];

    modal.style.display="block";

    //$.post( "http://{{ request.META.HTTP_HOST }}"+extra_base_url+"/ereader/api/reader", JSON.stringify(
    $.post( "http://{{ request.META.HTTP_HOST }}"+extra_base_url+"/api/reader", JSON.stringify(
         {"user": {{ request.user.id }},
         "session": "{{ request.session.session_key }}",
         "group": "{{ group }}",
         "section": current_section_id,
         "name": section_name,
         "resource": resource_id,
         "page": page_num,
         "action":"open-video",
         "datetime": new Date().toIsoString(),
         "visible_text": [],
         "extra": {"videoid":video_id,"resid":rec_resource_id,"rank":ranking,"score":score,"noise":is_noise,"rating":rating,"exp":explanation_rating}}));

    $(".modal-body").empty();

    $(".quiz-title").html("Video recommendation");
    $(".modal-footer").empty();
    $(".modal-body").append('<div id="video-player-div"></div>').ready(function(){
        player = new YT.Player('video-player-div', {
          height: '360',
          width: '640',
          videoId: video_id,
          events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange
          }
        });
    });

    //Helps to mark the rating that was provided by the student in the past
    var checked = ["","","",""];
    var icon_rate_btn = "fa-square";
    var class_rate_btn = "unchecked";

    if(rating!="" && rating!="no"){
        checked[rating]="checked";
        icon_rate_btn = "fa-check-square";
        class_rate_btn = "checked";
    }

    var ratings_div =
        '<div id="panel-ratings"><span id="prompt-video-watching">Please, watch this video in order to be able to rate it</span><br>'+
        '<div id="ratings-div">Is this recommended video relevant for the section you just read?<br>\n'+
        '<div id="relevance-rating-div">'+
        '<img src="{% static "reader/img/0-star.png" %}" alt="0 star" height="20" width="20"><input type="radio" name="relevance" value="0" '+checked[0]+'> Not relevant at all<br>' +
        '<img src="{% static "reader/img/1-star.png" %}" alt="1 star" height="20" width="20"><input type="radio" name="relevance" value="1" '+checked[1]+'> Relevant for the course but not for the current section<br>' +
        '<img src="{% static "reader/img/2-star.png" %}" alt="2 star" height="20" width="40"><input type="radio" name="relevance" value="2" '+checked[2]+'> Partly relevant for the current section<br>'+
        '<img src="{% static "reader/img/3-star.png" %}" alt="3 star" height="20" width="60"><input type="radio" name="relevance" value="3" '+checked[3]+'> Relevant for the current section<br>'+
        '<div id="rating-exp">Why? (please, provide a short explanation)</div><textarea id="rating-explanation" rows="3" cols="100">'+explanation_rating+'</textarea><button class="'+class_rate_btn+'-rate-btn" id="rate-btn">Rate video <i class="far '+icon_rate_btn+'"></i></button>' +
        '</div>'+
        '<div id="relevance-reason-div" style="display:none;">Why?<select id="relevance-reason-cb">' +
        '  <option value="r1">Reason a</option>' +
        '  <option value="r2">Reason b</option>' +
        '  <option value="r3">Reason c</option></select>' +
        '</div></div>' +
        '<div id="concept-mapping-div-modal">'+
        '<div id="concept-map-prompt">If you think the video is relevant for the section (you rated it with either <img src="{% static "reader/img/2-star.png" %}" alt="2 star" height="20" width="40"> or <img src="{% static "reader/img/3-star.png" %}" alt="2 star" height="20" width="60">) please use the concept map to describe the new information that the video addresses (concept or relationship between concepts):</div>' +
        '<div id="concept-map-div-modal"></div>'+
        '</div></div>';


    $(".modal-body").append(ratings_div);


    if(concept_map){
      loadConceptMap(user_id, current_section_id, section_name, "concept-map-div-modal");
    }

    //Log the video rating
    //$('input[type=radio][name=relevance]').change(function() {
    $('#rate-btn').click( function(e) {
        e.preventDefault();
        var error_message = "";
        if($( 'input[name=relevance]:checked' ).length>0){
             var rating = $( 'input[name=relevance]:checked' ).val();
             var explanation =  $('textarea#rating-explanation').val();
             if(explanation==""){
                error_message += "Please provide a short explanation for your rating."
             }else{
                 var rank=$("#"+video_id).attr("rank");
                 var score=$("#"+video_id).attr("score");
                 var noise=$("#"+video_id).attr("noise");
                 //Log this rating
                 $.post( "http://{{ request.META.HTTP_HOST }}"+extra_base_url+"/api/recommender/rate_resource", JSON.stringify(
                   {
                       "user": {{ request.user.id }},
                       "session": "{{ request.session.session_key }}",
                       "group": "{{ group }}",
                       "section": current_section_id,
                       "page": last_page_read["page"],
                       "datetime": new Date().toIsoString(),
                       "res_id": rec_resource_id,
                       "rating": rating,//1 to 4 (1 not relevant, 2 relevant for the course but not for the section, 3 , 4 relevant for the section)
                       "type": "video_relevance",
                       "explanation": explanation,
                       "extra": {"rank":rank,"score":score,"noise":noise}
                   })).done(function(data){
                     //Updates UI of recommended videos in the main window
                     $("#"+video_id).attr("exp",explanation);
                     $("#"+video_id).attr("rating",rating);
                     $("#"+video_id).find(".video-thumbnail-div").empty();
                     var root_src_img_rating = "{% static "reader/img/"%}";
                     var src_img_rating = root_src_img_rating + rating + "-star.png";
                     var video_section_content = $('<img class="video-thumbnail" src="//img.youtube.com/vi/'+video_id+'/0.jpg"><div class="rating">Your rating:</br><img src="'+src_img_rating+'" alt="'+rating+' star" height="15px"></img></div>');
                     $("#"+video_id).find(".video-thumbnail-div").append(video_section_content);

                     //Updates the button to show feedback that the rating was stored in db
                     $("#rate-btn").empty();
                     $("#rate-btn").append('Rate video <i class="far fa-check-square"></i>');
                     $("#rate-btn").addClass("checked-rate-btn").removeClass("unchecked-rate-btn")

                     });

                 return;
             }
        }else{
            error_message = "You have to select one of the categories for rating this video recommendation. " + error_message;
        }
        //Alert user of the error is doing
        alert (error_message);
    });


    //or for example
    var options = {
        max_value: 3,
        step_size: 1,
    }

}

function loadActivityModal(act_url){
     $(".modal-body").empty();

    $(".quiz-title").html("Related learning activity");
    $(".modal-footer").empty();
    $(".modal-body").append('<iframe frameBorder="0" src="'+act_url+'" style="width:95%; height:95%;"></iframe>');

    modal.style.display="block";
}

if (!Date.prototype.toISOString) {
  (function() {

    function pad(number) {
      if (number < 10) {
        return '0' + number;
      }
      return number;
    }

    Date.prototype.toISOString = function() {
      return this.getUTCFullYear() +
        '-' + pad(this.getUTCMonth() + 1) +
        '-' + pad(this.getUTCDate()) +
        'T' + pad(this.getUTCHours()) +
        ':' + pad(this.getUTCMinutes()) +
        ':' + pad(this.getUTCSeconds()) +
        '.' + (this.getUTCMilliseconds() / 1000).toFixed(3).slice(2, 5) +
        'Z';
    };

  }());
}

function updateRecommendations(){

    var ir_groups = ["IRSpring2018"];
    var java_groups = ["INFSCI0017Fall17"];

    //if(java_groups.includes(group)){
        /*recommended_activities = [{name:"sphereVolume",url:"http://adapt2.sis.pitt.edu/lti/launch?tool=codeworkout&sub=sphereVolume&svc=masterygrids&grp=SPLICELTI&usr=akhuseyinoglu&sid=39F8E&cid=368"},
            {name:"Print Name Initials", url:"http://pawscomp2.sis.pitt.edu/pcex/pcex_v2/index.html?lang=JAVA&set=strings.substring&lineRec=1&svc=masterygrids&grp=ADL&usr=adl01&sid=2871C&cid=345&v=201803162257"}];

        if($("#right").length == 0){
            $('#reader-div').append('<div id="right">' +
            '<a id="right-handle" class="handle ui-slideouttab-handle ui-slideouttab-handle-rounded">Related activities<i class="fa fa-icon fa-bank"></i></a>' +
            '      <div id="right-subpanel">' +
            '      <div id="recommended-activities-list"></div>' +
            '      </div>' +
            '</div>');

            $('#right').tabSlideOut({
              tabLocation: 'right',
              offsetReverse: true, // position the panel from the bottom of the page, rather than the top
              otherOffset: '40px', // force panel to be fixed height (required to get the scrollbars to appear in the sub-panel)
              handleOffsetReverse: true, // position the tab from the bottom of the panel, rather than the top
              onLoadSlideOut: true, // open by default
              clickScreenToCloseFilters: [
                    'button', // ignore button clicks
                    function(event){ // custom filter
                        // filters need to return true to filter out the click passed in the parameter
                        return $('#keepTabOpen').is(':checked');
                    }
              ]
            });
        }
        for(var i=0; i<recommended_activities.length;i++){
            var activity = recommended_activities[i];
            var act_url = activity.url;
            var act_name = activity.name;
            var act_html = $('<div class="activity-div" id="'+act_name+'" url="'+act_url+'"></br><span>'+act_name+'</span></div>');
            $('#recommended-activities-list').append(act_html);
        }

        var test_item_html_pcrs = "<div class='activity' url='https://vm003.teach.cs.toronto.edu/dev_serve/problems/java/358/embed?act=PCRS&sub=while2_coding&lineRec=1&svc=masterygrids&grp=ADL&usr=adl06&sid=3BA01&cid=361'>"+
            "<span class='fa-stack fa-2x'>"+
            "<i class='fa fa-circle fa-stack-2x' style='color: #a6e7a7;'></i>"+
            "<i class='far fa-circle fa-stack-2x'></i>"+
            "<i class='fas fa-laptop-code fa-stack-1x'></i>"+
            "</span></div>";

        var test_item_html_quizjet = "<div class='activity' url='http://pawscomp2.sis.pitt.edu/quizjet/displayQuiz.jsp?rdfID=jwhile2&act=Loops_while&sub=jWhile2&svc=progvis&lineRec=1&svc=masterygrids&grp=ADL&usr=adl01&sid=TEST'>"+
            "<span class='fa-stack fa-2x'>"+
            "<i class='fa fa-circle fa-stack-2x' style='color: #fb9999;'></i>"+
            "<i class='far fa-circle fa-stack-2x'></i>"+
            "<i class='fas fa-question fa-stack-1x'></i>"+
            "</span></div>";

        //var test_item_html =  "<div class='activity' url='https://vm003.teach.cs.toronto.edu/dev_serve/problems/java/358/embed?act=PCRS&sub=while2_coding&lineRec=1&svc=masterygrids&grp=ADL&usr=adl06&sid=3BA01&cid=361'><i class='circle-icon fa fa-question'></i></div>";
        if(!$(".t.m1.xb.h5.y4d.ff3.fs3.fc1.sc0.ls2.ws3").has(".activity").length){
            $(".t.m1.xb.h5.y4d.ff3.fs3.fc1.sc0.ls2.ws3").append(test_item_html_pcrs);
            $(".t.m1.xb.h5.y4d.ff3.fs3.fc1.sc0.ls2.ws3").append(test_item_html_quizjet);
        }

        var codeworkouts_id="repeatEnd";
        var test_item_html_codeworkouts = "<div id='"+codeworkouts_id+"' class='activity' url='http://adapt2.sis.pitt.edu/lti/launch?tool=codeworkout&sub=repeatEnd&svc=masterygrids&grp=SPLICELTI&usr=akhuseyinoglu&sid=39F8E&cid=368'>"+
            "<span class='fa-stack fa-2x'>"+
            "<i id='"+codeworkouts_id+"-icon'class='fa fa-circle fa-stack-2x' style='color: #D3D3D3;'></i>"+
            "<i class='far fa-circle fa-stack-2x'></i>"+
            "<i class='fas fa-keyboard fa-stack-1x'></i>"+
            "</span></div>";

        var animation_id="ae_while_v2";
        var test_item_html_animation = "<div class='activity' url='https://acos.cs.hut.fi/pitt/jsvee/jsvee-java/animation?example-id=ae_while_v2&svc=masterygrids&grp=SPLICELTI&usr=akhuseyinoglu&sid=TEST&cid=361'>" +
            "<span class='fa-stack fa-2x'>"+
            "<i class='fa fa-circle fa-stack-2x' style='color: #a6e7a7;'></i>"+
            "<i class='far fa-circle fa-stack-2x'></i>"+
            "<i class='fas fa-indent fa-stack-1x'></i>"+
            "</span></div>";

        //var test_item_html_pcex_example = "<div class='activity' url='http://pawscomp2.sis.pitt.edu/pcex/pcex_v2/index.html?lang=JAVA&set=while_loops.win_percentage&lineRec=1&svc=masterygrids&grp=ADL&usr=akhuseyinoglu&sid=2871C&cid=368&v=201803162257'>"+
        var pcex_id = "while_loops.win_percentage";
        var test_item_html_pcex = "<div class='activity' url='http://pawscomp2.sis.pitt.edu/pcex/pcex_v2/index.html?lang=JAVA&set=while_loops.win_percentage&ch=JWinPercentageInput&svc=masterygrids&grp=ADL&usr=akhuseyinoglu&sid=TEST&cid=361&v=201803162257'>"+
            "<span class='fa-stack fa-2x'>"+
            "<i class='fa fa-circle fa-stack-2x' style='color: #fb9999;'></i>"+
            "<i class='far fa-circle fa-stack-2x'></i>"+
            "<i class='fas fa-stream fa-stack-1x'></i>"+
            "</span></div>";


        if(!$(".t.m1.xb.h5.y32.ff3.fs3.fc1.sc0.ls2.ws3").has(".activity").length) {
            $(".t.m1.xb.h5.y32.ff3.fs3.fc1.sc0.ls2.ws3").append(test_item_html_codeworkouts);
            $(".t.m1.xb.h5.y32.ff3.fs3.fc1.sc0.ls2.ws3").append(test_item_html_animation);
            $(".t.m1.xb.h5.y32.ff3.fs3.fc1.sc0.ls2.ws3").append(test_item_html_pcex);
        }

        $(".activity").click(function(){
            var act_url = $(this).attr('url');
            loadActivityModal(act_url);
        });


        /*$(".activity-div").click(function(){
            var act_url = $(this).attr('url');
            loadActivityModal(act_url);
        });*/
    //}else {
        recommended_videos = [];

        //var old_section_id = last_page_read["resourceid"]+"-"+last_page_read["id"];
        var old_section_id = last_page_read["docno"];

        var new_section_id = map_old_new_section_ids[old_section_id];

        new_section_id = "section-"+new_section_id.replace(/_/g, "-");

        $.ajax({
        //url: 'http://halley.exp.sis.pitt.edu/behnam/book/api.php?sid='+new_section_id,
        url: "http://{{ request.META.HTTP_HOST }}"+extra_base_url+'/api/recommender/recommended_videos?method='+recommendation_approach+'&page='+new_section_id+'&user='+user_id+'&group='+group_id+'&section='+current_section_id,
        type: 'GET',
        crossDomain: true,
        success: function(data) {
            console.log("Success!");
            console.log(data);
            //if(data["message"] == "OK"){
                //recommended_videos = data["items"];
                recommended_videos = data["recommended_videos"];
                if($("#right").length == 0){
                    $('#reader-div').append('<div id="right">' +
                    '<a id="right-handle" class="handle ui-slideouttab-handle ui-slideouttab-handle-rounded">Recommended videos  <i class="far fa-play-circle fa-lg"></i></a>' +
                    '      <div id="right-subpanel">' +
                    '      <div id="recommended-videos-list"></div>' +
                    '      </div>' +
                    '</div>');

                    $('#right').tabSlideOut({
                      tabLocation: 'right',
                      offsetReverse: true, // position the panel from the bottom of the page, rather than the top
                      otherOffset: '40px', // force panel to be fixed height (required to get the scrollbars to appear in the sub-panel)
                      handleOffsetReverse: true, // position the tab from the bottom of the panel, rather than the top
                      onLoadSlideOut: true, // open by default
                      /* don't close this tab if a button is clicked, or if the checkbox is set */
                      clickScreenToCloseFilters: [
                            'button', // ignore button clicks
                            function(event){ // custom filter
                                // filters need to return true to filter out the click passed in the parameter
                                return $('#keepTabOpen').is(':checked');
                            }
                      ]
                    });

                    //Register when they hide or open the video recommendation panel
                    $(document).on('slideouttabopen slideouttabclose slideouttabbounce',function(event){
                        var $panel = $(event.target);
                        var eventType = event.type;
                        var video_panel_action = "";
                        if(eventType=="slideouttabopen"){
                            video_panel_action = "open-video-panel";
                        }else{
                            if(eventType=="slideouttabclose"){
                                video_panel_action = "hide-video-panel"
                            }
                        }
                        if(video_panel_action!="") {
                            $.post("http://{{ request.META.HTTP_HOST }}" + extra_base_url + "/api/reader", JSON.stringify(
                                {
                                    "user": {{ request.user.id }},
                                    "session": "{{ request.session.session_key }}",
                                    "group": "{{ group }}",
                                    "section": current_section_id,
                                    "name": last_page_read["name"],
                                    "page": last_page_read["page"],
                                    "resource": last_page_read["resourceid"],
                                    "action": video_panel_action,
                                    "datetime": new Date().toIsoString(),
                                    "visible_text": [],
                                    "extra": {}
                                }));
                        }
                    });
                }

                $('#recommended-videos-list').html("");

                for(var i=0; i<recommended_videos.length;i++){
                    //console.log(recommended_videos[i]);
                    var youtube_video_url = recommended_videos[i].url
                    var youtube_video_id = youtube_video_url.substring(youtube_video_url.indexOf("?v=")+3,youtube_video_url.length);
                    var video_title = recommended_videos[i].title;
                    var resource_id = recommended_videos[i].id;
                    var rating_video = recommended_videos[i].rating;
                    var explanation_rating = recommended_videos[i].explanation_rating;
                    var score = recommended_videos[i].value;
                    var rank = recommended_videos[i].rank;
                    var noise = recommended_videos[i].noise;
                    if(rating_video=="" || rating_video==-1){
                        rating_video="no";
                    }
                    var root_src_img_rating = "{% static "reader/img/"%}";
                    var src_img_rating = root_src_img_rating + rating_video + "-star.png";
                    var video_section = $('<div class="video-div" id="'+youtube_video_id+'" rank="'+rank+'" score="'+score+'" noise="'+noise+'" rating="'+rating_video+'" exp="'+explanation_rating+'" resid="'+resource_id+'"><div class="video-thumbnail-div"><img class="video-thumbnail" src="//img.youtube.com/vi/'+youtube_video_id+'/0.jpg"><div class="rating">Your rating:</br><img src="'+src_img_rating+'" alt="'+rating_video+' star" height="15px"></img></div></div><div class="video-metadata-div"><span class="video-title">'+video_title+'</span></div></div>');
                    $('#recommended-videos-list').append(video_section);
                }
                $(".video-div").click(function(){
                    var video_id = $(this).attr('id');
                    var res_id = $(this).attr('resid');
                    var rating = $(this).attr('rating');
                    var explanation_rating = $(this).attr('exp');
                    var ranking = $(this).attr("rank");
                    var score = $(this).attr("score");
                    var is_noise = $(this).attr("noise")
                    openVideoWindow(video_id,res_id,rating,explanation_rating,ranking,score,is_noise);
                });
            //}
        },
        error: function(data) { console.log(data); console.log('Failed!'); }
    });
    //}
}

//Function that helps to find a certain node in the hierarchical structure of the course json
function findSection(source, id){
    for (key in source)
    {
        var item = source[key];
        if (item.id == id)
            return item;

        // Item not returned yet. Search its children by recursive call.
        if (item.children)
        {
            var subresult = findSection(item.children, id);

            // If the item was found in the subchildren, return it.
            if (subresult)
                return subresult;
        }
    }
    // Nothing found yet? return null.
    return null;
}


function loadConceptMap(user_id, section_id, section_name, container_id){

     var cm_section_id = section_id;
     var cm_section_name = section_name;
     if(d3.select("#toc-section-"+section_id).datum().depth==4){
         cm_section_id=d3.select("#toc-section-"+section_id).datum().parent.id;
         cm_section_name=d3.select("#toc-section-"+section_id).datum().parent.name;
     }

    //concept_map_width = $("#concept-map-div").innerWidth();
    //concept_map_height =  $("#concept-map-div").innerHeight();

    concept_map_width = $("#"+container_id).innerWidth();
    concept_map_height =  $("#"+container_id).innerHeight();

    $.ajax({
        url: "http://{{ request.META.HTTP_HOST }}"+extra_base_url+'/api/knowledgevis/concept_map?user='+user_id+'&section='+cm_section_id,
        type: 'GET',
        crossDomain: true,
        dataType: "json",
        success: function(data) {

            //Remove svg in case it existed before
             $("#"+container_id).empty();

             //Append instructions for interacting with the concept map
            $("#"+container_id).append("<div class='concept-map-help-div'>"+
                "<span id='concept-map-title'>Section: "+cm_section_name+"</span><br>"+
                "Please use this space to create a concept map to visually represent the ideas and information that were covered in the section. Some automatically extracted concepts are provided. Feel free to add, modifiy or eliminate concepts as well as the relationships between them.</br>"+
                "<a target='_blank' href='https://www.youtube.com/watch?v=bFWXQ_CqR18'><img id='video-tutorial-img' src='{% static 'reader/img/video-tutorial-icon.png' %}' title='Watch a tutorial for understanding how to use the system' /></a><button type='button' class='collapsible'>How to edit the concept map?</button>" +
                "<div class='content-collapsible'>" +
                "  Create concept: shift key + click </br>Delete concept: click concept + delete key</br>Rename concept: shift key + click concept</br> Create link: shift key + click source concept + drag cursor to target concept </br>Delete link: click link + delete key</br>Rename concept: shift key + click link" +
                "</div>"+
                //"<button type='button' class='collapsible'>Tips for creating concept maps</button>" +
                "<div class='content-collapsible'>" +
                "  " +
                "</div>"+
                "</div>");

            var coll = document.getElementsByClassName("collapsible");
            var i;

            for (i = 0; i < coll.length; i++) {
              coll[i].addEventListener("click", function() {
                this.classList.toggle("active");
                var content = this.nextElementSibling;
                if (content.style.display === "block") {
                  content.style.display = "none";
                } else {
                  content.style.display = "block";
                }
              });
            }

            var concept_map_svg = d3.select("#"+container_id).append("svg")
                .attr("class","svg-concept-map")
                //.attr("width",window.innerWidth)
                //.attr("height",window.innerHeight)
                .attr("width",concept_map_width)
                .attr("height",concept_map_height)
                .attr("preserveAspectRatio", "xMinYMin meet")
                .attr("viewBox", "0 0 "+concept_map_width+" "+concept_map_height);
               // .attr("viewBox", "0 0 460 520");

            if(data.result){
                var jsonCM = data.conceptMap;
	        		var nodes = jsonCM.nodes;
	        		var edges = jsonCM.edges;
	        		edges.forEach(function(e, i){
	                    edges[i] = {source: nodes.filter(function(n){return n.id == e.source;})[0],
	                                   target: nodes.filter(function(n){return n.id == e.target;})[0],
	                                   type: e.type,
	                                   title: e.title};//code added by jbarriapineda to include type of links in uploaded json to draw the graph
	                  });
	        		var graph = new GraphCreator(concept_map_svg, nodes, edges, user_id, cm_section_id, group_id, session);
	        		graph.setIdCt(nodes.length + 1);
	        		graph.updateGraph();
	        		$('#colorpicker').change(function(){
	        	        var nodeColor = $(this).find("option:selected").attr('value');
	        	        graph.state.nodeColor=nodeColor;
	        	    });
                //drawExistentConceptMap(svg,cmid,user_id);
            }else{

                var automatic_concepts = [];

                //var old_section_id = last_page_read["docno"];
                var old_section_id = "iir-"+cm_section_id;
                var new_section_id = map_old_new_section_ids[old_section_id];
                new_section_id = new_section_id.replace(/_/g, "-");

                var automatic_concepts_path = "automatic_concepts/"+new_section_id+".txt";

                $.ajax({
                    type: "GET",
                    url:"{% static "/" %}"+automatic_concepts_path,
                    success: function (data){
                       var lines = data.split('\n');
                       for(var i = 0; i < lines.length; i++) {
                          if(i>0){
                              var line =lines[i];
                              var concept_values = line.split(",");
                              var concept = concept_values[0];
                              if(concept!=""){
                                  automatic_concepts.push(concept);
                              }

                          }
                       }
                       var json_new_graph_string = '{"nodes":[{"title":"Concept1","id":0,"x":204.2353515625,"y":158.853515625,"color":"#c2c2c2","stroke":0},{"id":2,"title":"Concept2","x":126.33846282958984,"y":233.52301025390625,"color":"#c2c2c2","stroke":0},{"id":3,"title":"Concept3","x":150.94239044189453,"y":332.99365234375,"color":"#c2c2c2","stroke":0},{"id":4,"title":"Concept4","x":281.6811828613281,"y":233.1337890625,"color":"#c2c2c2","stroke":0},{"id":5,"title":"Concept5","x":253.23483276367188,"y":334.7513427734375,"color":"#c2c2c2","stroke":0}],"edges":[]}';

                       if(automatic_concepts.length==0){
                            automatic_concepts = ["Concept1","Concept2","Concept3","Concept4","Concept5"];
                        }

                        var sample_automatic_concepts = getRandomSubarray(automatic_concepts,5);

                        for(var i=0;i<sample_automatic_concepts.length;i++){
                            var concept_name = "Concept"+(i+1);
                            json_new_graph_string = json_new_graph_string.replace(concept_name,sample_automatic_concepts[i]);
                        }

                        var json_new_graph = JSON.parse(json_new_graph_string);

                        var nodes = json_new_graph.nodes;
                        var edges = json_new_graph.edges;

                        var graph = new GraphCreator(concept_map_svg, nodes, edges, user_id, cm_section_id, group_id, session);

                        graph.setIdCt(nodes.length+1);
                        graph.updateGraph();

                        //Register in db the first randomly generated concept map from the automatically extracted concepts (avoid potential system gaming)
                        graph.logAction("initial-cm",cm_section_id,"");

                        //$('#colorpicker').change(function(){
                        //        var nodeColor = $(this).find("option:selected").attr('value');
                        //        graph.state.nodeColor=nodeColor;
                        //});
                        //drawNewConceptMap(concept_map_svg,user_id);
                        },
                        error:function(err){
                            console.log("error on getting automatic concepts");
                        }
                      });

                /*
                //TODO: make this process automatic (create a table in the database in order to pull this information, given an automatic extraction method)
                //Section 4.1
                if(section_id=="2105"){
                    automatic_concepts = ["disk","chunk","hardware basic","caching","block","byte","ir system","seek time","megabyte","data transfer"];
                }
                //Section 4.2
                if(section_id=="2106") {
                    automatic_concepts = ["block","sort based indexing", "sorting", "byte", "token", "posting list","term","main memory","inverted index","key"]
                }
                //Section 4.3
                if(section_id=="2107"){
                    automatic_concepts = ["block", "memory", "token", "single pass", "posting list", "sorting", "dictionary term", "compression", "data structure", "algorithm"];
                }
                //Section 4.4
                if (section_id=="2108"){
                    automatic_concepts=["parser","inverter","distributed indexing","map","index construction","split","key pair","node","chunk","mapping"];
                }
                //Section 4.5
                if(section_id=="2109"){
                    automatic_concepts=["auxiliary index","merge","main index","logarithmic merging","posting list","memory","scratch","dynamic indexing","query processing","file system"];
                }
                //Section 4.6
                if(section_id=="2110") {
                    automatic_concepts=["user","posting list","block","sort based indexing","result list","positional index","query processing","spelling correction","list document","merging"];
                }
                //Section 5.1
                if(section_id=="2113" || section_id=="2114" || section_id=="2115"){
                    automatic_concepts=["heap's law","zipf's law","stop word","folding","vocabulary size","stemming","reuters rcv","token","rank","frequent term"];
                }
                //Section 5.2
                if(section_id=="2116" || section_id=="2117" || section_id=="2118"){
                    automatic_concepts=["binary search","term pointer","term block","front coding","compressed dictionary","reuters rcv","dictionary compression","disk seek","search system","dictionary term"];
                }
                //Section 5.3
                if(section_id=="2119" || section_id=="2120" || section_id=="2121"){
                    automatic_concepts=["unary code","reuters rcv","bit word","compression ratio","variable byte code","posting file","posting list","entropy","index compression","compressed index"];
                }
                //Section 1.3
                if(section_id=="2157"){
                    automatic_concepts=["merge algorithm","result list","intersection operation","conjunctive query", "query processing", "linear", "posting list intersection", "optimization", "dictionary", "inverted index"]
                }
                //Section 1.4
                if(section_id=="2158"){
                    automatic_concepts = ["term","extended boolean model","web search engine", "retrieval system", "precision", "phrase search", "free text query", "document retrieval", "index", "indexing"]
                }
                //Section 6.1 and its subsections
                if(section_id=="2160" || section_id=="2161" || section_id=="2162" || section_id=="2163"){
                    automatic_concepts = ["training example","boolean","field","weighted zone scoring","zone index","relevance judgment","weighted zone score","body zone","dictionary","query term"];
                }
                //Section 6.2 and its subsections
                if(section_id == "2164" || section_id=="2165" || section_id=="2166"){
                    automatic_concepts = ["query term","inverse document frequency","collection frequency","tf idf weight","tf weight","weighting scheme","relevance","vector space model","term weighting", "weighting function"]
                }
                //Section 6.3
                if(section_id == "2167" || section_id=="2168" || section_id=="2169" || section_id=="2170"){
                    automatic_concepts = ["document vector","dot product","vector space model","query vector","cosine similarity","weighting scheme","tf idf weight","unit vector","term weighting","query term"];
                }
                //Section 6.4
                if(section_id == "2171" || section_id=="2172" || section_id=="2173" || section_id=="2174" || section_id=="2175"){
                    automatic_concepts = ["cosine normalization","document length normalization","term frequency","tf idf","normalized document","euclidean length","term weighting","document vector","query vector","euclidean distance"];
                }
                //Section 12.1
                if(section_id == "2178" || section_id=="2179" || section_id=="2180" || section_id=="2181"){
                    automatic_concepts = ["language model","multinomial distribution","likelihood ratio","multinomial coefficient","multinomial model","term vocabulary","context","topic","text","training sampl"];
                }
                //Section 12.2
                if(section_id == "2182" || section_id=="2183" || section_id=="2184" || section_id=="2185"){
                    automatic_concepts = ["language modeling approach","language model","mle","term weighting","document collection","query likelihood model","length normalization","collection frequency","term frequency","average precision"];
                }
                //Section 12.3
                if(section_id == "2186"){
                    automatic_concepts = ["idf","language modeling approach","performance","unigram model","language model","term frequency","type","xml retrieval","text retrieval","probabilistic approach"];
                }
                //Section 12.4
                if(section_id == "2187"){
                    automatic_concepts = ["translation model","language modeling approach","document likelihood model","relevance feedback model","document language model","probability distribution","ranking function","information theory","document retrieval","ad hoc retrieval"];
                }
                */
            }


        },
        error: function(data) { console.log(data); console.log('Failed!'); }
    });

    function getRandomSubarray(arr, size) {
        var shuffled = arr.slice(0), i = arr.length, temp, index;
        while (i--) {
            index = Math.floor((i + 1) * Math.random());
            temp = shuffled[index];
            shuffled[index] = shuffled[i];
            shuffled[i] = temp;
        }
        return shuffled.slice(0, size);
    }
}

</script>

</body>
</html>